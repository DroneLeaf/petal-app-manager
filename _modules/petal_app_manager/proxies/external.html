

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>petal_app_manager.proxies.external &mdash; Petal App Manager 0.2.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.min.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=ba7fdd6d" />

  
    <link rel="shortcut icon" href="../../../_static/cropped-site-icon.png"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=000c92bf"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="https://cdn.jsdelivr.net/npm/pseudocode@latest/build/pseudocode.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Petal App Manager
              <img src="../../../_static/White logo-vertical.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction.html#what-is-petal-app-manager">What is Petal App Manager?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../introduction.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../introduction.html#key-features">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../introduction.html#architecture">Architecture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../introduction.html#system-architecture-diagram">System Architecture Diagram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../introduction.html#architecture-components">Architecture Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../introduction.html#data-flow">Data Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../introduction.html#use-cases">Use Cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../introduction.html#why-petal-app-manager">Why Petal App Manager?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/dependencies.html">Dependencies Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/dependencies.html#system-requirements">System Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/dependencies.html#python-3-11-installation">Python 3.11 Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/dependencies.html#pdm-installation">PDM Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/dependencies.html#redis-installation-and-configuration">Redis Installation and Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/dependencies.html#redis-development-tools">Redis Development Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/dependencies.html#controller-dashboard">Controller Dashboard</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/quickstart.html">Quick Start Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#development-installation">Development Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#using-hear-cli-recommended">Using HEAR-CLI (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#manual-development-setup">Manual Development Setup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#production-installation">Production Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#id1">Using HEAR-CLI (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#custom-version-installation-field-testing">Custom Version Installation (Field Testing)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#manual-production-installation">Manual Production Installation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#environment-configuration">Environment Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#running-the-application">Running the Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#verifying-the-installation">Verifying the Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#quick-development-workflow">Quick Development Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to_use/index.html">How to Use</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../how_to_use/making_requests.html">Making Requests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/making_requests.html#using-the-postman-collection">Using the Postman Collection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/making_requests.html#using-the-docs-interface">Using the /docs Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/making_requests.html#accessing-swagger-ui">Accessing Swagger UI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/making_requests.html#interactive-api-testing">Interactive API Testing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/making_requests.html#using-redoc">Using ReDoc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/making_requests.html#example-api-calls">Example API Calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/making_requests.html#quick-testing-workflow">Quick Testing Workflow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../how_to_use/service_management.html">The Petal App Manager Service</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#admin-dashboard-interface">Admin Dashboard Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#accessing-the-admin-dashboard">Accessing the Admin Dashboard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#dashboard-features">Dashboard Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#using-the-admin-dashboard">Using the Admin Dashboard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#alternative-access-methods">Alternative Access Methods</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#managing-petals-and-proxies-via-api">Managing Petals and Proxies via API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#checking-what-s-running">Checking What’s Running</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#viewing-all-available-components">Viewing All Available Components</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#petal-control-via-api">Petal Control via API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#enabling-petals">Enabling Petals</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#disabling-petals">Disabling Petals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#proxy-control-via-api">Proxy Control via API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#enabling-proxies">Enabling Proxies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/service_management.html#disabling-proxies">Disabling Proxies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#common-use-cases">Common Use Cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#restart-management">Restart Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/service_management.html#service-files-and-locations">Service Files and Locations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../how_to_use/configuration.html">Configuration Changes in .env</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#environment-variables-overview">Environment Variables Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#general-configuration">General Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-log-level">PETAL_LOG_LEVEL</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-log-to-file">PETAL_LOG_TO_FILE</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-log-dir">PETAL_LOG_DIR</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#mavlink-configuration">MAVLink Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-mavlink-endpoint">PETAL_MAVLINK_ENDPOINT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-mavlink-baud">PETAL_MAVLINK_BAUD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#other-mavlink-settings">Other MAVLink Settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#cloud-configuration">Cloud Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#redis-configuration">Redis Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-redis-host-and-petal-redis-port">PETAL_REDIS_HOST and PETAL_REDIS_PORT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-redis-unix-socket-path">PETAL_REDIS_UNIX_SOCKET_PATH</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-redis-health-message-rate">PETAL_REDIS_HEALTH_MESSAGE_RATE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#database-configuration">Database Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#data-operations-urls">Data Operations URLs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#mqtt-configuration">MQTT Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#proxy-connection-retry-configuration">Proxy Connection Retry Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#petal-specific-configuration">Petal-Specific Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#applying-configuration-changes">Applying Configuration Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../how_to_use/configuration.html#configuration-examples">Configuration Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../development_contribution/index.html">Development and Contribution Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../development_contribution/adding_petals.html">Adding a New Petal Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#what-is-a-petal">What is a Petal?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#creating-a-new-petal">Creating a New Petal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#using-hear-cli-recommended">Using HEAR-CLI (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#manual-setup">Manual Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#petal-structure">Petal Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#key-components">Key Components</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#mqtt-command-handlers-mqtt-action">MQTT Command Handlers (<code class="docutils literal notranslate"><span class="pre">&#64;mqtt_action</span></code>)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#handler-signature">Handler Signature</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#the-cpu-heavy-parameter">The <code class="docutils literal notranslate"><span class="pre">cpu_heavy</span></code> Parameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#how-it-works-under-the-hood">How It Works Under the Hood</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#dynamic-factory-handlers">Dynamic / Factory Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#migration-from-legacy-pattern">Migration from Legacy Pattern</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#registering-the-petal">Registering the Petal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#adding-to-proxies-yaml">Adding to proxies.yaml</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#adding-to-pyproject-toml-for-production">Adding to pyproject.toml (for Production)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#installing-your-petal">Installing Your Petal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#development-installation-editable">Development Installation (Editable)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#production-installation-git-tag">Production Installation (Git Tag)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#testing-your-petal">Testing Your Petal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#integration-testing">Integration Testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#debugging">Debugging</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#best-practices">Best Practices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#naming-conventions">Naming Conventions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#proxy-management">Proxy Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#logging">Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#versioning">Versioning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#common-pitfalls">Common Pitfalls</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#petal-name-must-start-with-petal">Petal Name Must Start with <code class="docutils literal notranslate"><span class="pre">petal-*</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#petal-not-loading">Petal Not Loading</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/adding_petals.html#entry-point-errors">Entry Point Errors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/adding_petals.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html">Inter-Petal Communication Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#goal">Goal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#benefits">Benefits</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#implementation-guide">Implementation Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#for-sink-petal-developers-message-receivers">For Sink Petal Developers (Message Receivers)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#for-source-petal-developers-message-senders">For Source Petal Developers (Message Senders)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#best-practices">Best Practices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#data-model-design">Data Model Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#channel-naming-convention">Channel Naming Convention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#versioning">Versioning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#testing">Testing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#example-complete-implementation">Example: Complete Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#sink-petal-petal-leafsdk">Sink Petal (petal-leafsdk)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#source-petal-petal-qgc-mission-adapter">Source Petal (petal-qgc-mission-adapter)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#acceptance-criteria">Acceptance Criteria</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#reference-implementation">Reference Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#migration-path">Migration Path</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#for-existing-petals">For Existing Petals</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#deprecation-strategy">Deprecation Strategy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#additional-resources">Additional Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#common-issues">Common Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/inter-petal_communications.html#getting-help">Getting Help</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#dependency-architecture">Dependency Architecture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#understanding-the-petal-stack-dependencies">Understanding the Petal Stack Dependencies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#version-management-by-repository">Version Management by Repository</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#petal-app-manager">Petal App Manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#individual-petals">Individual Petals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#non-petal-packages">Non-Petal Packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#leafsdk">LeafSDK</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#mavlink-pymavlink-very-special-case">mavlink/pymavlink (Very Special Case)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#version-summary-table">Version Summary Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/contribution_guidelines.html#getting-help">Getting Help</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_contribution/using_proxies.html">Using Proxies in Petals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#available-proxy-types">Available Proxy Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#accessing-proxies-in-your-petal">Accessing Proxies in Your Petal</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#redisproxy">RedisProxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#mavlinkexternalproxy">MavlinkExternalProxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#clouddbproxy">CloudDBProxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#localdbproxy">LocalDBProxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#s3bucketproxy">S3BucketProxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#mqttproxy">MQTTProxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#error-handling-and-best-practices">Error Handling and Best Practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/using_proxies.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html">Advanced Debugging and Logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#available-logging-tools">Available Logging Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#per-level-logging-configuration">Per-Level Logging Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#configuration-methods">Configuration Methods</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#output-options">Output Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#common-configuration-scenarios">Common Configuration Scenarios</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#legacy-format-support">Legacy Format Support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#csv-signal-logging-tool">CSV Signal Logging Tool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#advanced-configuration">Advanced Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#complete-petal-example">Complete Petal Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#debugging-best-practices">Debugging Best Practices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#environment-specific-configuration">Environment-Specific Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#performance-considerations">Performance Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#error-handling-and-recovery">Error Handling and Recovery</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#integration-with-admin-dashboard">Integration with Admin Dashboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#testing-and-validation">Testing and Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#file-management">File Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/advanced_debugging.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_contribution/profiling.html">Petal App Manager Profiling Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#table-of-contents">Table of Contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#quick-start">Quick Start</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#prerequisites">1. Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#install-dependencies">2. Install Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#start-pam">3. Start PAM</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#run-profiling-and-or-monitoring">4. Run Profiling and/or Monitoring</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#view-results">5. View Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#command-line-flags">6. Command-Line Flags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#profiling-scenarios">Profiling Scenarios</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#workflow-for-profiling-different-scenarios">Workflow for Profiling Different Scenarios</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#example-sitl-mission-for-profiling">Example SITL Mission for Profiling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#output-formats-visualizations">Output Formats &amp; Visualizations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#speedscope-json-interactive">Speedscope JSON (Interactive) ⭐</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#monitor-output-cpu-and-memory-usage">Monitor Output: CPU and Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#interpretation-guide">Interpretation Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#what-to-look-for">What to Look For</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#reading-flame-graphs">Reading Flame Graphs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#common-patterns-to-identify">Common Patterns to Identify</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#environment-issues">Environment Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#profiler-issues">Profiler Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#visualization-issues">Visualization Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#performance-issues">Performance Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#results-interpretation-issues">Results Interpretation Issues</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#quick-reference">Quick Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#command-cheatsheet">Command Cheatsheet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#file-naming-conventions">File Naming Conventions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../development_contribution/profiling.html#keyboard-shortcuts-speedscope">Keyboard Shortcuts (Speedscope)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#getting-help">Getting Help</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_contribution/profiling.html#summary">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../petal_documentation/index.html">Petal Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html">Petal User Journey Coordinator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#required-proxies">Required Proxies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#command-categories">Command Categories</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#esc-calibration-commands">ESC Calibration Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#esc-calibration">esc_calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#esc-force-run-all">esc_force_run_all</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#esc-force-run-single">esc_force_run_single</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#esc-calibration-single">esc_calibration_single</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#parameter-configuration-commands">Parameter Configuration Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#geometry">geometry</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#gps-module">gps_module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#dist-module">dist_module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#oflow-module">oflow_module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#gps-spatial-offset">gps_spatial_offset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#distance-spatial-offset">distance_spatial_offset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#optical-flow-spatial-offset">optical_flow_spatial_offset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#esc-update-calibration-limits">esc_update_calibration_limits</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#bulk-parameter-operations">Bulk Parameter Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#bulk-set-parameters">bulk_set_parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#bulk-get-parameters">bulk_get_parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#real-time-telemetry-streams">Real-Time Telemetry Streams</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#subscribe-rc-value-stream">subscribe_rc_value_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#unsubscribe-rc-value-stream">unsubscribe_rc_value_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#subscribe-pose-value-stream">subscribe_pose_value_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#unsubscribe-pose-value-stream">unsubscribe_pose_value_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#subscribe-ks-status-stream">subscribe_ks_status_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#unsubscribe-ks-status-stream">unsubscribe_ks_status_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#subscribe-mfs-a-status-stream-subscribe-mfs-b-status-stream">subscribe_mfs_a_status_stream / subscribe_mfs_b_status_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#unsubscribeall">unsubscribeall</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#trajectory-verification-commands">Trajectory Verification Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#verify-pos-yaw-directions">verify_pos_yaw_directions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#verify-pos-yaw-directions-complete">verify_pos_yaw_directions_complete</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#wifi-optitrack-commands">WiFi &amp; OptiTrack Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#connect-to-wifi-and-verify-optitrack">connect_to_wifi_and_verify_optitrack</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#set-static-ip-address">set_static_ip_address</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#system-commands">System Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#reboot-px4">reboot_px4</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#format-sd-card">format_sd_card</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#get-log-entries">get_log_entries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#complete-usage-example">Complete Usage Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#error-handling">Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#mqtt-topics-reference">MQTT Topics Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#commands-received-on-command-edge">Commands (Received on <code class="docutils literal notranslate"><span class="pre">command/edge</span></code>)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#published-topics-sent-to-command-web">Published Topics (Sent to <code class="docutils literal notranslate"><span class="pre">command/web</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_user_journey_coordinator.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html">Petal Flight Log</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#required-proxies">Required Proxies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#command-categories">Command Categories</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#flight-record-fetch-commands">Flight Record Fetch Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#fetch-flight-records">fetch_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#subscribe-fetch-flight-records">subscribe_fetch_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#unsubscribe-fetch-flight-records">unsubscribe_fetch_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#cancel-fetch-flight-records">cancel_fetch_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#fetch-existing-flight-records">fetch_existing_flight_records</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#flight-record-sync-commands">Flight Record Sync Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#start-sync-flight-record">start_sync_flight_record</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#subscribe-sync-job-value-stream">subscribe_sync_job_value_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#unsubscribe-sync-job-value-stream">unsubscribe_sync_job_value_stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#cancel-sync-job">cancel_sync_job</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#flight-record-management-commands">Flight Record Management Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#delete-flight-record">delete_flight_record</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#bulk-delete-flight-records-commands">Bulk Delete Flight Records Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#bulk-delete-flight-records">bulk_delete_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#subscribe-bulk-delete-flight-records">subscribe_bulk_delete_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#unsubscribe-bulk-delete-flight-records">unsubscribe_bulk_delete_flight_records</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#cancel-bulk-delete-flight-records">cancel_bulk_delete_flight_records</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#clear-error-logs-commands">Clear Error Logs Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#detect-error-logs">detect_error_logs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#clear-error-logs">clear_error_logs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#clear-all-ulogs-commands">Clear All ULogs Commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#clear-all-ulogs">clear_all_ulogs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#subscribe-clear-all-ulogs">subscribe_clear_all_ulogs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#unsubscribe-clear-all-ulogs">unsubscribe_clear_all_ulogs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#cancel-clear-all-ulogs">cancel_clear_all_ulogs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#job-status-values">Job Status Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#mqtt-topics-reference">MQTT Topics Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#data-models">Data Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#flightrecordmatch">FlightRecordMatch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#error-handling">Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#id1">MQTT Topics Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#commands-received-on-command-edge">Commands (Received on <code class="docutils literal notranslate"><span class="pre">command/edge</span></code>)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#published-topics-sent-to-command-web">Published Topics (Sent to <code class="docutils literal notranslate"><span class="pre">command/web</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../petal_documentation/petal_flight_log.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-2-2-2026-02-22">Version 0.2.2 (2026-02-22)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-2-1-2026-02-12">Version 0.2.1 (2026-02-12)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-2-0-2026-02-12">Version 0.2.0 (2026-02-12)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-62-2026-02-06">Version 0.1.62 (2026-02-06)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-61-2026-02-03">Version 0.1.61 (2026-02-03)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-60-2026-01-30">Version 0.1.60 (2026-01-30)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-59-2026-01-27">Version 0.1.59 (2026-01-27)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-57-2026-01-18">Version 0.1.57 (2026-01-18)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-56-2026-01-17">Version 0.1.56 (2026-01-17)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-54-2026-01-15">Version 0.1.54 (2026-01-15)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-53-2026-01-15">Version 0.1.53 (2026-01-15)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-52-2026-01-14">Version 0.1.52 (2026-01-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-51-2026-01-08">Version 0.1.51 (2026-01-08)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-50-2026-01-05">Version 0.1.50 (2026-01-05)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-49-2025-01-05">Version 0.1.49 (2025-01-05)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-48-2025-12-31">Version 0.1.48 (2025-12-31)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-47-2025-12-31">Version 0.1.47 (2025-12-31)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-46-2025-12-31">Version 0.1.46 (2025-12-31)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-45-2025-11-23">Version 0.1.45 (2025-11-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-44-2025-11-07">Version 0.1.44 (2025-11-07)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-43-2025-11-05-hotfix">Version 0.1.43 (2025-11-05) - Hotfix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-42-2025-11-03">Version 0.1.42 (2025-11-03)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-41-2025-11-02">Version 0.1.41 (2025-11-02)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-39-2025-10-23">Version 0.1.39 (2025-10-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-38-2025-10-23">Version 0.1.38 (2025-10-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-37-2025-10-22">Version 0.1.37 (2025-10-22)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-31-2025-09-25">Version 0.1.31 (2025-09-25)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-29-2025-08-28">Version 0.1.29 (2025-08-28)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-28-2025-08-17">Version 0.1.28 (2025-08-17)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-23-2025-07-31">Version 0.1.23 (2025-07-31)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-18-2025-07-29">Version 0.1.18 (2025-07-29)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-5-2025-07-03-first-stable-release">Version 0.1.5 (2025-07-03) - First Stable Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../changelog.html#version-0-1-0-2025-06-22-initial-release">Version 0.1.0 (2025-06-22) - Initial Release</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/core_api.html">Core API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.admin_ui">Admin UI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.admin_ui.admin_dashboard"><code class="docutils literal notranslate"><span class="pre">admin_dashboard()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.admin_ui.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.health">Health Endpoints</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.health.detailed_health_check"><code class="docutils literal notranslate"><span class="pre">detailed_health_check()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.health.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.health.health_check"><code class="docutils literal notranslate"><span class="pre">health_check()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.health.organization_health_check"><code class="docutils literal notranslate"><span class="pre">organization_health_check()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.config_api">Configuration API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.AllComponentsResponse"><code class="docutils literal notranslate"><span class="pre">AllComponentsResponse</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.ConfigResponse"><code class="docutils literal notranslate"><span class="pre">ConfigResponse</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.PetalControlRequest"><code class="docutils literal notranslate"><span class="pre">PetalControlRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.PetalInfo"><code class="docutils literal notranslate"><span class="pre">PetalInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.ProxyInfo"><code class="docutils literal notranslate"><span class="pre">ProxyInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.control_petals"><code class="docutils literal notranslate"><span class="pre">control_petals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.control_proxies"><code class="docutils literal notranslate"><span class="pre">control_proxies()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.get_status"><code class="docutils literal notranslate"><span class="pre">get_status()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.config_api.list_all_components"><code class="docutils literal notranslate"><span class="pre">list_all_components()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.cloud_api">Cloud API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.GetItemRequest"><code class="docutils literal notranslate"><span class="pre">GetItemRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.ScanTableRequest"><code class="docutils literal notranslate"><span class="pre">ScanTableRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.SetItemRequest"><code class="docutils literal notranslate"><span class="pre">SetItemRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.UpdateItemRequest"><code class="docutils literal notranslate"><span class="pre">UpdateItemRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.delete_item"><code class="docutils literal notranslate"><span class="pre">delete_item()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.get_item"><code class="docutils literal notranslate"><span class="pre">get_item()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.scan_table"><code class="docutils literal notranslate"><span class="pre">scan_table()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.set_item"><code class="docutils literal notranslate"><span class="pre">set_item()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.cloud_api.update_item"><code class="docutils literal notranslate"><span class="pre">update_item()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.bucket_api">Bucket API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.bucket_api.delete_file_test"><code class="docutils literal notranslate"><span class="pre">delete_file_test()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.bucket_api.download_file_test"><code class="docutils literal notranslate"><span class="pre">download_file_test()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.bucket_api.get_info"><code class="docutils literal notranslate"><span class="pre">get_info()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.bucket_api.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.bucket_api.list_files_test"><code class="docutils literal notranslate"><span class="pre">list_files_test()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.bucket_api.upload_file_test"><code class="docutils literal notranslate"><span class="pre">upload_file_test()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.mavftp_api">MAVLink FTP API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mavftp_api.ClearFailLogsRequest"><code class="docutils literal notranslate"><span class="pre">ClearFailLogsRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mavftp_api.clear_fail_logs"><code class="docutils literal notranslate"><span class="pre">clear_fail_logs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mavftp_api.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mavftp_api.list_directory"><code class="docutils literal notranslate"><span class="pre">list_directory()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.mqtt_api">MQTT API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.MQTTResponse"><code class="docutils literal notranslate"><span class="pre">MQTTResponse</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.PublishMessageRequest"><code class="docutils literal notranslate"><span class="pre">PublishMessageRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.SubscribePatternRequest"><code class="docutils literal notranslate"><span class="pre">SubscribePatternRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.SubscribeTopicRequest"><code class="docutils literal notranslate"><span class="pre">SubscribeTopicRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.UnsubscribeTopicRequest"><code class="docutils literal notranslate"><span class="pre">UnsubscribeTopicRequest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.get_mqtt_status"><code class="docutils literal notranslate"><span class="pre">get_mqtt_status()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.list_subscriptions"><code class="docutils literal notranslate"><span class="pre">list_subscriptions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.publish_message"><code class="docutils literal notranslate"><span class="pre">publish_message()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.subscribe_topic"><code class="docutils literal notranslate"><span class="pre">subscribe_topic()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.mqtt_api.unsubscribe_topic"><code class="docutils literal notranslate"><span class="pre">unsubscribe_topic()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/core_api.html#module-petal_app_manager.api.proxy_info">Proxy Info</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.proxy_info.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/core_api.html#petal_app_manager.api.proxy_info.list_proxies"><code class="docutils literal notranslate"><span class="pre">list_proxies()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/proxies.html">Proxies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.base">Base Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.base.BaseProxy"><code class="docutils literal notranslate"><span class="pre">BaseProxy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.redis">Redis Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#redisproxy">RedisProxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.redis.RedisProxy"><code class="docutils literal notranslate"><span class="pre">RedisProxy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.external">External MAVLink Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petalappmanager-proxies-external">petalappmanager.proxies.external</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.DownloadCancelledException"><code class="docutils literal notranslate"><span class="pre">DownloadCancelledException</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy"><code class="docutils literal notranslate"><span class="pre">ExternalProxy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.FTPDeleteError"><code class="docutils literal notranslate"><span class="pre">FTPDeleteError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy"><code class="docutils literal notranslate"><span class="pre">MavLinkExternalProxy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy"><code class="docutils literal notranslate"><span class="pre">MavLinkFTPProxy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ULogInfo"><code class="docutils literal notranslate"><span class="pre">ULogInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.setup_file_only_logger"><code class="docutils literal notranslate"><span class="pre">setup_file_only_logger()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.localdb">Local Database Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#localdbproxy">LocalDBProxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.localdb.LocalDBProxy"><code class="docutils literal notranslate"><span class="pre">LocalDBProxy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.cloud">Cloud Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#clouddbproxy">CloudDBProxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.cloud.CloudDBProxy"><code class="docutils literal notranslate"><span class="pre">CloudDBProxy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.bucket">Bucket Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.bucket.S3BucketProxy"><code class="docutils literal notranslate"><span class="pre">S3BucketProxy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/proxies.html#module-petal_app_manager.proxies.mqtt">MQTT Proxy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#mqttproxy">MQTTProxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.mqtt.MQTTProxy"><code class="docutils literal notranslate"><span class="pre">MQTTProxy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/proxies.html#petal_app_manager.proxies.mqtt.MessageCallback"><code class="docutils literal notranslate"><span class="pre">MessageCallback</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/plugins.html">Plugins System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/plugins.html#module-petal_app_manager.plugins.base">Base Petal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.base.Petal"><code class="docutils literal notranslate"><span class="pre">Petal</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/plugins.html#module-petal_app_manager.plugins.decorators">Decorators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.decorators.http_action"><code class="docutils literal notranslate"><span class="pre">http_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.decorators.mqtt_action"><code class="docutils literal notranslate"><span class="pre">mqtt_action()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.decorators.websocket_action"><code class="docutils literal notranslate"><span class="pre">websocket_action()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/plugins.html#module-petal_app_manager.plugins.loader">Loader</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.loader.initialize_petals"><code class="docutils literal notranslate"><span class="pre">initialize_petals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.loader.load_petals"><code class="docutils literal notranslate"><span class="pre">load_petals()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/plugins.html#petal_app_manager.plugins.loader.startup_petals"><code class="docutils literal notranslate"><span class="pre">startup_petals()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/petals.html">Available Petals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/petals.html#production-petals">Production Petals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/petals.html#petal-flight-log">petal-flight-log</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/petals.html#petal-warehouse">petal-warehouse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/petals.html#petal-leafsdk">petal-leafsdk</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/petals.html#petal-user-journey-coordinator">petal-user-journey-coordinator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api_reference/petals.html#development-petals">Development Petals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api_reference/petals.html#petal-qgc-mission-server">petal-qgc-mission-server</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api_reference/index.html#core-modules">Core Modules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_issues.html">Known Issues</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#petal-issues">Petal Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#petal-name-must-start-with-petal">Petal Name Must Start with <code class="docutils literal notranslate"><span class="pre">petal-*</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#petal-not-getting-loaded">Petal Not Getting Loaded</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#python-3-11-issues">Python 3.11 Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#python-3-11-not-found">Python 3.11 Not Found</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#pdm-issues">PDM Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#pdm-installation-fails">PDM Installation Fails</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#pdm-lock-file-issues">PDM Lock File Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#redis-issues">Redis Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#redis-connection-errors">Redis Connection Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#redis-configuration-issues">Redis Configuration Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#mavlink-issues">MAVLink Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#mavlink-connection-issues">MAVLink Connection Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#mavlink-submodule-branch-issues-sitl">MAVLink Submodule Branch Issues (SITL)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#mqtt-issues">MQTT Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#mqtt-proxy-fails-on-fresh-installation">MQTT Proxy Fails on Fresh Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#port-conflicts">Port Conflicts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../known_issues.html#port-9000-already-in-use">Port 9000 Already in Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../known_issues.html#reporting-issues">Reporting Issues</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Petal App Manager</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">petal_app_manager.proxies.external</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for petal_app_manager.proxies.external</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">petalappmanager.proxies.external</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">Thread-based proxies for long-running I/O back-ends (MAVLink, ROS 1, …).</span>

<span class="sd">Key changes vs. the first draft:</span>
<span class="sd">--------------------------------</span>
<span class="sd">* All per-key buffers are now :class:`collections.deque` with ``maxlen``.</span>
<span class="sd">  New data silently overwrites the oldest entry → bounded memory.</span>
<span class="sd">* Public API (``send``, ``register_handler``) is unchanged for petals.</span>
<span class="sd">* Docstrings preserved / expanded for clarity.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span> 
    <span class="n">Callable</span><span class="p">,</span> 
    <span class="n">Deque</span><span class="p">,</span> 
    <span class="n">Dict</span><span class="p">,</span> 
    <span class="n">List</span><span class="p">,</span> 
    <span class="n">Mapping</span><span class="p">,</span> 
    <span class="n">Tuple</span><span class="p">,</span> 
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Union</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="o">,</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseProxy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..models.mavlink</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RebootStatusCode</span><span class="p">,</span>
    <span class="n">RebootAutopilotResponse</span><span class="p">,</span>
    <span class="n">FormatStorageResponse</span><span class="p">,</span> 
    <span class="n">FormatStorageStatusCode</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymavlink</span><span class="w"> </span><span class="kn">import</span> <span class="n">mavutil</span><span class="p">,</span> <span class="n">mavftp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymavlink.mavftp_op</span><span class="w"> </span><span class="kn">import</span> <span class="n">FTP_OP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymavlink.dialects.v20</span><span class="w"> </span><span class="kn">import</span> <span class="nb">all</span> <span class="k">as</span> <span class="n">mavlink_dialect</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># import rospy   # ← uncomment in ROS-enabled environments</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dotenv</span>

<span class="n">_PARAM_TYPE_NAME_TO_ID</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;UINT8&quot;</span><span class="p">:</span>  <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT8</span><span class="p">,</span>
    <span class="s2">&quot;INT8&quot;</span><span class="p">:</span>   <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT8</span><span class="p">,</span>
    <span class="s2">&quot;UINT16&quot;</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT16</span><span class="p">,</span>
    <span class="s2">&quot;INT16&quot;</span><span class="p">:</span>  <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT16</span><span class="p">,</span>
    <span class="s2">&quot;UINT32&quot;</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT32</span><span class="p">,</span>
    <span class="s2">&quot;INT32&quot;</span><span class="p">:</span>  <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT32</span><span class="p">,</span>
    <span class="s2">&quot;UINT64&quot;</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT64</span><span class="p">,</span>
    <span class="s2">&quot;INT64&quot;</span><span class="p">:</span>  <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT64</span><span class="p">,</span>
    <span class="s2">&quot;REAL32&quot;</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL32</span><span class="p">,</span>
    <span class="s2">&quot;REAL64&quot;</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL64</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_INT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT8</span><span class="p">,</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT8</span><span class="p">,</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT16</span><span class="p">,</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT16</span><span class="p">,</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT32</span><span class="p">,</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT32</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_FLOAT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL32</span><span class="p">,</span>
    <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL64</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ParamSpec</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span>
    <span class="n">Any</span><span class="p">,</span>                            <span class="c1"># value only</span>
    <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>    <span class="c1"># (value, &quot;UINT16&quot;) or (value, MAV_PARAM_TYPE_INT32)</span>
    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>                 <span class="c1"># {&quot;value&quot;: ..., &quot;type&quot;: &quot;INT16&quot;}</span>
<span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_parse_param_type</span><span class="p">(</span><span class="n">ptype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accept:</span>
<span class="sd">      - None</span>
<span class="sd">      - int (already a MAV_PARAM_TYPE_* value)</span>
<span class="sd">      - strings like &quot;UINT16&quot;, &quot;int32&quot;, &quot;MAV_PARAM_TYPE_INT32&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ptype</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">ptype</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;MAV_PARAM_TYPE_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">_PARAM_TYPE_NAME_TO_ID</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_PARAM_TYPE_NAME_TO_ID</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported param type specifier: </span><span class="si">{</span><span class="n">ptype</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bits</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">signed</span><span class="p">:</span>
        <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="s1">&#39;INT&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;UINT&#39;</span><span class="si">}{</span><span class="n">bits</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">lo</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">hi</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_u32_to_f32_bits</span><span class="p">(</span><span class="n">u32</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;f&quot;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">u32</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_f32_bits_to_u32</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;f&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_sign_extend</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bits</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">sign_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">value</span> <span class="o">&amp;=</span> <span class="n">mask</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">^</span> <span class="n">sign_bit</span><span class="p">)</span> <span class="o">-</span> <span class="n">sign_bit</span>

<div class="viewcode-block" id="setup_file_only_logger">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.setup_file_only_logger">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_file_only_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup a logger that only writes to files, not console.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    
    <span class="c1"># Clear any existing handlers to avoid console output</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    
    <span class="c1"># Create file handler</span>
    <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    
    <span class="c1"># Create formatter</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> — </span><span class="si">%(name)s</span><span class="s1"> — </span><span class="si">%(levelname)s</span><span class="s1"> — </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    
    <span class="c1"># Add handler to logger</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
    
    <span class="c1"># Prevent propagation to root logger (which might log to console)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="n">logger</span></div>


<span class="c1"># --------------------------------------------------------------------------- #</span>
<span class="c1">#  Public dataclasses returned to petals / REST                               #</span>
<span class="c1"># --------------------------------------------------------------------------- #</span>

<div class="viewcode-block" id="ULogInfo">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ULogInfo">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ULogInfo</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metadata for a ULog that resides on the PX4 SD-card.&quot;&quot;&quot;</span>
    <span class="n">index</span>      <span class="p">:</span> <span class="nb">int</span>          <span class="c1"># 0-based index in the list</span>
    <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">size_bytes</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">utc</span>        <span class="p">:</span> <span class="nb">int</span>          <span class="c1"># epoch seconds</span></div>


<span class="c1"># Progress callback signature used by download_ulog</span>
<span class="n">ProgressCB</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]</span>       <span class="c1"># 0.0 - 1.0</span>

<div class="viewcode-block" id="DownloadCancelledException">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.DownloadCancelledException">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DownloadCancelledException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a download is cancelled by the user.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="FTPDeleteError">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.FTPDeleteError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FTPDeleteError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a MAVFTP delete operation fails with a known FTP error code.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ftp_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp_code</span> <span class="o">=</span> <span class="n">ftp_code</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>



<span class="c1"># ──────────────────────────────────────────────────────────────────────────────</span>
<div class="viewcode-block" id="ExternalProxy">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExternalProxy</span><span class="p">(</span><span class="n">BaseProxy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for I/O drivers that must *poll* or *listen* continuously.</span>

<span class="sd">    A dedicated thread calls :py:meth:`_io_read_once` / :py:meth:`_io_write_once`</span>
<span class="sd">    in a tight loop while the FastAPI event-loop thread stays unblocked.</span>

<span class="sd">    * **Send buffers** - ``self._send[key]`` (deque, newest → right side)</span>
<span class="sd">      Outbound messages are enqueued here via :py:meth:`send`.</span>
<span class="sd">      The I/O thread drains these buffers by calling</span>
<span class="sd">      :py:meth:`_io_write_once` with all pending messages.</span>

<span class="sd">    * **Handlers** - ``self._handlers[key]``</span>
<span class="sd">      Callbacks registered via :py:meth:`register_handler` are stored here.</span>
<span class="sd">      When new messages arrive via :py:meth:`_io_read_once`, they are</span>
<span class="sd">      processed directly in the I/O recv thread, which schedules</span>
<span class="sd">      async handlers on the event loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ──────────────────────────────────────────────────────── public helpers ──</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sleep_time_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        maxlen :</span>
<span class="sd">            Maximum number of messages kept *per key* in both send/recv maps.</span>
<span class="sd">            A value of 0 or ``None`` means *unbounded* (not recommended).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>

        <span class="k">if</span> <span class="n">sleep_time_ms</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sleep_time_ms</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sleep_time_ms</span> <span class="o">=</span> <span class="n">sleep_time_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sleep_time_reader_ms</span> <span class="o">=</span> <span class="n">sleep_time_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Deque</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_message_times</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="c1"># Thread management (I/O threads only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_running</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="ExternalProxy.register_handler">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy.register_handler">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]],</span> 
        <span class="n">duplicate_filter_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">queue_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cpu_heavy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach an async callback *fn* so it fires for **every** message appended to ``_recv[key]``.</span>

<span class="sd">        The callback is scheduled on the main event loop for thread-safe execution.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            The key to register the handler for.</span>
<span class="sd">        fn : Callable[[Any], Awaitable[None]]</span>
<span class="sd">            The async handler function to call for each message.</span>
<span class="sd">        duplicate_filter_interval : Optional[float]</span>
<span class="sd">            If specified, duplicate messages received within this interval (in seconds)</span>
<span class="sd">            will be filtered out and the handler will not be called. None disables filtering.</span>
<span class="sd">        queue_length : Optional[int]</span>
<span class="sd">            If specified, sets the maximum length of the message buffer for *key*.</span>
<span class="sd">            New messages overwrite the oldest when the buffer is full.</span>
<span class="sd">            If None, the default maxlen from proxy initialization is used.</span>
<span class="sd">        cpu_heavy : bool</span>
<span class="sd">            If True, the handler&#39;s CPU-bound work will be offloaded to a</span>
<span class="sd">            thread-pool executor managed by the proxy, preventing event-loop</span>
<span class="sd">            starvation.  The handler must still be ``async def``, but it may</span>
<span class="sd">            call ``await loop.run_in_executor(...)`` internally—or simply set</span>
<span class="sd">            this flag and the proxy will wrap the entire handler invocation</span>
<span class="sd">            in ``run_in_executor`` automatically.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If *fn* is not an async function (coroutine).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Handler must be an async function (coroutine). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instead. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Define your handler with &#39;async def&#39; instead of &#39;def&#39;.&quot;</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;duplicate_filter_interval&#39;</span><span class="p">:</span> <span class="n">duplicate_filter_interval</span><span class="p">,</span>
            <span class="s1">&#39;cpu_heavy&#39;</span><span class="p">:</span> <span class="n">cpu_heavy</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="ExternalProxy.unregister_handler">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy.unregister_handler">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unregister_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the callback *fn* from the broadcast list attached to *key*.</span>

<span class="sd">        If *fn* was not registered, the call is silently ignored.</span>
<span class="sd">        When the last callback for *key* is removed, the key itself is pruned</span>
<span class="sd">        to keep the dict size small.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># nothing registered under that key</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Tried to unregister handler </span><span class="si">%s</span><span class="s2"> for key &#39;</span><span class="si">%s</span><span class="s2">&#39; but it was not found.&quot;</span><span class="p">,</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">key</span>
            <span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># fn was not in the list; ignore</span>

        <span class="c1"># Clean up handler config</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span> <span class="ow">and</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">fn</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="c1"># last handler -&gt; prune everything for that key</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="ExternalProxy.send">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy.send">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">burst_count</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
             <span class="n">burst_interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue *msg* for transmission.  The newest message is kept if the</span>
<span class="sd">        buffer is already full.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            The key to send the message on.</span>
<span class="sd">        msg : Any</span>
<span class="sd">            The message to send.</span>
<span class="sd">        burst_count : Optional[int]</span>
<span class="sd">            If specified, send the message this many times in a burst.</span>
<span class="sd">        burst_interval : Optional[float]</span>
<span class="sd">            If burst_count is specified, wait this many seconds between each message.</span>
<span class="sd">            If None, all messages are sent immediately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">burst_count</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">burst_count</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Single message send</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">))</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Burst send</span>
            <span class="k">if</span> <span class="n">burst_interval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">burst_interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Send all messages immediately</span>
                <span class="n">send_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">burst_count</span><span class="p">):</span>
                    <span class="n">send_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Schedule burst with intervals using a background task</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Check if we&#39;re in the same thread as the event loop</span>
                        <span class="n">current_loop</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">current_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                            <span class="n">current_loop</span> <span class="o">=</span> <span class="kc">None</span>
                        
                        <span class="k">if</span> <span class="n">current_loop</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">:</span>
                            <span class="c1"># We&#39;re in the event loop thread, create task directly</span>
                            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_send_burst</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">burst_count</span><span class="p">,</span> <span class="n">burst_interval</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="c1"># Store the task reference to prevent garbage collection</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_burst_tasks&#39;</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                            <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># We&#39;re in a different thread, schedule on proxy&#39;s loop</span>
                            <span class="k">def</span><span class="w"> </span><span class="nf">schedule_burst</span><span class="p">():</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_send_burst</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">burst_count</span><span class="p">,</span> <span class="n">burst_interval</span><span class="p">)</span>
                                    <span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_burst_tasks&#39;</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                                    <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to schedule burst task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">schedule_burst</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># If task creation fails, fall back to immediate send</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create burst task: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, sending immediately&quot;</span><span class="p">)</span>
                        <span class="n">send_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">burst_count</span><span class="p">):</span>
                            <span class="n">send_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If no loop is available, fall back to immediate send</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No event loop available for burst with interval, sending immediately&quot;</span><span class="p">)</span>
                    <span class="n">send_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">burst_count</span><span class="p">):</span>
                        <span class="n">send_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_burst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a burst of messages with specified interval.&quot;&quot;&quot;</span>
        <span class="n">send_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">))</span>
        
        <span class="c1"># Send messages with proper intervals</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">send_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Burst message </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> queued for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Don&#39;t sleep after the last message</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

    <span class="c1"># ───────────────────────────────────────────── FastAPI life-cycle hooks ──</span>
<div class="viewcode-block" id="ExternalProxy.start">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the I/O threads and begin polling/writing.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Initialize burst tasks tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># Start I/O threads for send/recv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv_body</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">-Recv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_body</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">-Send&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="ExternalProxy.stop">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.ExternalProxy.stop">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ask the I/O threads to exit and join them (best-effort, 5 s timeout).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Cancel any pending burst tasks</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_burst_tasks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="c1"># Wait for tasks to complete cancellation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_burst_tasks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Stop I/O send thread</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_send</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Stop I/O recv thread</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_thread_recv</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="c1"># ─────────────────────────────────────────────── subclass responsibilities ─</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_io_read_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve **zero or more** `(key, message)` tuples from the device /</span>
<span class="sd">        middleware *without blocking*.</span>

<span class="sd">        Returning an empty list is perfectly fine.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_io_write_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Push pending outbound messages to the device / middleware.</span>

<span class="sd">        ``batches`` maps *key* → list of messages drained from ``_send[key]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># ─────────────────────────────────────────── internal worker main-loop ──</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_send_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;I/O thread body - drains send queues.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">pending</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dq</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">while</span> <span class="n">dq</span><span class="p">:</span>
                    <span class="n">pending</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dq</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_io_write_once</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Sleep briefly if there&#39;s nothing to send to avoid busy-waiting</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sleep_time_ms</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_recv_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;I/O thread body - polls recv and processes messages with handlers directly.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_read_once</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sleep_time_reader_ms</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">):</span>                
                <span class="c1"># Process directly in recv thread (handlers are async, dispatched to event loop)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_message_with_handlers</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            
    <span class="c1"># ─────────────────────────────────────────── message processing ──</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_invoke_callback_safely</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cpu_heavy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely invoke an async callback by scheduling it on the main event loop.</span>

<span class="sd">        All callbacks are required to be async functions.</span>
<span class="sd">        When *cpu_heavy* is ``True`` the coroutine is wrapped so that its body</span>
<span class="sd">        executes inside ``loop.run_in_executor`` (thread pool), keeping the</span>
<span class="sd">        event loop free for other work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cpu_heavy</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_offloaded</span><span class="p">():</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">_offloaded</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;[ExternalProxy] Cannot invoke async callback for key &#39;</span><span class="si">%s</span><span class="s2">&#39;: &quot;</span>
                    <span class="s2">&quot;event loop not available&quot;</span><span class="p">,</span>
                    <span class="n">key</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;[ExternalProxy] Error invoking callback for key &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_message_with_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a single message by invoking all registered handlers for the key.</span>
<span class="sd">        This runs in the I/O recv thread and handles duplicate filtering.</span>
<span class="sd">        Handlers are async and scheduled on the event loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if duplicate filtering is enabled for this handler</span>
                <span class="n">handler_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handler_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">filter_interval</span> <span class="o">=</span> <span class="n">handler_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duplicate_filter_interval&#39;</span><span class="p">)</span>
                
                <span class="n">should_call_handler</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">filter_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Convert message to string for comparison</span>
                    <span class="n">msg_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">handler_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    
                    <span class="c1"># Check if we&#39;ve seen this exact message recently for this handler</span>
                    <span class="k">if</span> <span class="n">handler_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_message_times</span><span class="p">:</span>
                        <span class="n">last_msg_str</span><span class="p">,</span> <span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_message_times</span><span class="p">[</span><span class="n">handler_key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">msg_str</span> <span class="o">==</span> <span class="n">last_msg_str</span> <span class="ow">and</span> 
                            <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_time</span> <span class="o">&lt;</span> <span class="n">filter_interval</span><span class="p">):</span>
                            <span class="n">should_call_handler</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;[ExternalProxy] Filtered duplicate message for handler </span><span class="si">%s</span><span class="s2"> on key &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                                <span class="n">cb</span><span class="p">,</span> <span class="n">key</span>
                            <span class="p">)</span>
                    
                    <span class="c1"># Update last message time for this handler</span>
                    <span class="k">if</span> <span class="n">should_call_handler</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_last_message_times</span><span class="p">[</span><span class="n">handler_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_str</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">should_call_handler</span><span class="p">:</span>
                    <span class="n">is_cpu_heavy</span> <span class="o">=</span> <span class="n">handler_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu_heavy&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_callback_safely</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">cpu_heavy</span><span class="o">=</span><span class="n">is_cpu_heavy</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;[ExternalProxy] handler </span><span class="si">%s</span><span class="s2"> called for key &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">cb</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">msg</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>          <span class="c1"># never kill the loop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;[ExternalProxy] handler </span><span class="si">%s</span><span class="s2"> raised: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">cb</span><span class="p">,</span> <span class="n">exc</span>
                <span class="p">)</span></div>


<span class="c1"># ──────────────────────────────────────────────────────────────────────────────</span>
<div class="viewcode-block" id="MavLinkExternalProxy">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MavLinkExternalProxy</span><span class="p">(</span><span class="n">ExternalProxy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Threaded MAVLink driver using `pymavlink`.</span>

<span class="sd">    Buffers used</span>
<span class="sd">    ------------</span>
<span class="sd">    * ``send[&quot;mav&quot;]``                      - outbound :class:`MAVLink_message`</span>
<span class="sd">    * ``recv[&quot;mav&quot;]``                      - any inbound message</span>
<span class="sd">    * ``recv[str(msg.get_msgId())]``       - by numeric ID</span>
<span class="sd">    * ``recv[msg.get_type()]``             - by string type</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">baud</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_system_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_component_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">maxlen</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mavlink_worker_sleep_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">mavlink_heartbeat_send_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">root_sd_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fs/microsd/log&#39;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">sleep_time_ms</span><span class="o">=</span><span class="n">mavlink_worker_sleep_ms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_system_id</span> <span class="o">=</span> <span class="n">source_system_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_component_id</span> <span class="o">=</span> <span class="n">source_component_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_heartbeat_send_frequency</span> <span class="o">=</span> <span class="n">mavlink_heartbeat_send_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_sd_path</span> <span class="o">=</span> <span class="n">root_sd_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavfile</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Set up file-only logging</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">PETAL_LOG_DIR</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s2">&quot;app-mavlinkexternalproxy.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span> <span class="o">=</span> <span class="n">setup_file_only_logger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MavLinkExternalProxyMsgs&quot;</span><span class="p">,</span> 
            <span class="n">log_file</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span> 
            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;MavLinkExternalProxy&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thread_name_prefix</span><span class="o">=</span><span class="s2">&quot;MavLinkExternalProxy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaf_fc_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_leaf_fc_heartbeat_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_check_interval</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Check connection every 5 seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_timeout</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># Consider disconnected if no heartbeat for 60s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_fc_heartbeat_timeout</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Consider Leaf FC disconnected if no heartbeat for 30s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_interval</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Wait 2s between reconnection attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_monitor_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_pending</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>  <span class="c1"># Prevent concurrent downloads</span>
        
        <span class="c1"># Rate limiting for logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_log_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_interval</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;HEARTBEAT&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>        <span class="c1"># Log heartbeats every 10 seconds max</span>
            <span class="s1">&#39;MISSION_CURRENT&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>   <span class="c1"># Log mission current every 5 seconds max</span>
            <span class="s1">&#39;ATTITUDE&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>         <span class="c1"># Log attitude every 30 seconds max</span>
            <span class="s1">&#39;POSITION&#39;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>         <span class="c1"># Log position every 30 seconds max</span>
            <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span> <span class="mf">2.0</span>            <span class="c1"># Default interval for other messages</span>
        <span class="p">}</span>
        
        <span class="c1"># Messages to suppress completely (only show at DEBUG level)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suppress_messages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;SERVO_OUTPUT_RAW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ACTUATOR_MOTORS&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ATTITUDE_QUATERNION&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LOCAL_POSITION_NED&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GLOBAL_POSITION_INT&#39;</span>
        <span class="p">}</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize parameter name by removing null padding.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_param_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decode a PARAM_VALUE message.</span>
<span class="sd">        If type==INT32, reinterpret the float bits as int32.</span>
<span class="sd">        If type==UINT32, reinterpret the float bits as uint32.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : MAVLink_param_value_message</span>
<span class="sd">            The PARAM_VALUE message to decode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[str, Any]</span>
<span class="sd">            The parameter name and decoded value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_name</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">param_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="ow">in</span> <span class="n">_INT_TYPES</span><span class="p">:</span>
            <span class="n">raw_u32</span> <span class="o">=</span> <span class="n">_f32_bits_to_u32</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">param_value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT8</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">raw_u32</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT8</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_sign_extend</span><span class="p">(</span><span class="n">raw_u32</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT16</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">raw_u32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT16</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_sign_extend</span><span class="p">(</span><span class="n">raw_u32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT32</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">raw_u32</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT32</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_sign_extend</span><span class="p">(</span><span class="n">raw_u32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Shouldn&#39;t happen due to _INT_TYPES, but keep safe</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">raw_u32</span>

            <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span>

        <span class="c1"># REAL32 (what PX4 mostly uses)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">param_value</span><span class="p">)</span>

        <span class="c1"># Classic PARAM_* can&#39;t reliably carry REAL64/INT64/UINT64; if they appear, just pass through float field</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">param_value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_param_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">param_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encode a parameter value for transmission.</span>
<span class="sd">        For INT32 types, encode the int32 bits as float32 for wire transmission.</span>
<span class="sd">        For UINT32 types, encode the uint32 bits as float32 for wire transmission.</span>
<span class="sd">        Returns the float value to put in param_value field.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : Any</span>
<span class="sd">            The parameter value to encode.</span>
<span class="sd">        param_type : int</span>
<span class="sd">            The MAV_PARAM_TYPE_* type of the parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The encoded float value for transmission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_type</span> <span class="ow">in</span> <span class="n">_INT_TYPES</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT8</span><span class="p">:</span>
                <span class="n">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT8</span><span class="p">:</span>
                <span class="n">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT16</span><span class="p">:</span>
                <span class="n">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT16</span><span class="p">:</span>
                <span class="n">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
            <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT32</span><span class="p">:</span>
                <span class="n">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT32</span><span class="p">:</span>
                <span class="n">_check_int_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u32</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

            <span class="k">return</span> <span class="n">_u32_to_f32_bits</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL32</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Classic PARAM_SET can&#39;t carry 64-bit values; refuse explicitly</span>
        <span class="k">if</span> <span class="n">param_type</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_UINT64</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT64</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL64</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;64-bit PARAM_SET not supported; use PARAM_EXT_* for 64-bit/REAL64 parameters&quot;</span><span class="p">)</span>

        <span class="c1"># Fallback</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_should_log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if a message should be logged based on rate limiting&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Suppress high-frequency messages completely at INFO level</span>
        <span class="k">if</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_suppress_messages</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># Get the appropriate interval for this message type</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_interval</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_interval</span><span class="p">[</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">])</span>
        
        <span class="c1"># Check if enough time has passed since last log</span>
        <span class="n">last_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_log_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_type</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_log</span> <span class="o">&gt;=</span> <span class="n">interval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_log_time</span><span class="p">[</span><span class="n">msg_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">return</span> <span class="kc">False</span>
        

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">target_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the target system ID of the MAVLink connection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">target_component</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the target component ID of the MAVLink connection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># ------------------------ life-cycle --------------------- #</span>
<div class="viewcode-block" id="MavLinkExternalProxy.start">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the MAVLink connection then launch the worker thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        
        <span class="c1"># Schedule initial connection attempt in background (non-blocking)</span>
        <span class="c1"># This allows the server to start immediately without waiting for MAVLink</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_connection_attempt</span><span class="p">())</span>

        <span class="c1"># Start the worker thread first</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Start connection monitoring and heartbeat tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_monitor_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_connection</span><span class="p">())</span>
        
        <span class="c1"># send heartbeat at configured frequency</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_heartbeat_send_frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mavlink_heartbeat_send_frequency</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">frequency</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Heartbeat frequency must be positive&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid self.mavlink_heartbeat_send_frequency: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="mf">5.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_heartbeat_periodically</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">))</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_initial_connection_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt initial MAVLink connection in the background.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting initial MAVLink connection to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_establish_connection</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial MAVLink connection successful&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial MAVLink connection failed - will retry in background&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial MAVLink connection attempt failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> - will retry in background&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_establish_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish MAVLink connection and wait for heartbeat.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
                <span class="c1"># Check if any FTP operations are in progress before closing connection</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot establish new connection - FTP operation in progress&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                    
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Ignore errors when closing old connection</span>
            
            <span class="c1"># Run the blocking connection establishment in a separate thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_mavlink_connection</span>
            <span class="p">)</span>

            <span class="c1"># Try to get a heartbeat with timeout - also run in executor</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">heartbeat_received</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_heartbeat</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">heartbeat_received</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MAVLink connection established - Heartbeat from sys </span><span class="si">%s</span><span class="s2">, comp </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">)</span>
                    
                    <span class="c1"># Register heartbeat handler to track connection health</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_heartbeat_received</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mavlink_dialect</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_HEARTBEAT</span><span class="p">),</span> <span class="p">[]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mavlink_dialect</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_HEARTBEAT</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_heartbeat_received</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_leaf_fc_heartbeat_received</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mavlink_dialect</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_LEAF_HEARTBEAT</span><span class="p">),</span> <span class="p">[]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mavlink_dialect</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_LEAF_HEARTBEAT</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_leaf_fc_heartbeat_received</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No heartbeat received from MAVLink endpoint </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Socket error during heartbeat wait: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error waiting for heartbeat: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error establishing MAVLink connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_mavlink_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create MAVLink connection in a separate thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink_connection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> 
            <span class="n">baud</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">baud</span><span class="p">,</span> 
            <span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="n">source_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_system_id</span><span class="p">,</span>
            <span class="n">source_component</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_component_id</span>
        <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for heartbeat in a separate thread.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">wait_heartbeat</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_on_heartbeat_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handler for incoming heartbeat messages to track connection health.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MAVLink connection re-established&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_on_leaf_fc_heartbeat_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handler for incoming heartbeat messages to track connection health.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_leaf_fc_heartbeat_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaf_fc_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leaf_fc_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Leaf FC connection re-established&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_monitor_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Monitor connection health and trigger reconnection if needed.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="c1"># Skip monitoring if _mav_lock is held (FTP operation in progress)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_leaf_fc_heartbeat_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_check_interval</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_check_interval</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping connection monitoring - FTP operation in progress&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_check_interval</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Check if we haven&#39;t received a Leaf FC heartbeat recently</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_leaf_fc_heartbeat_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_leaf_fc_heartbeat_timeout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaf_fc_connected</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Leaf FC heartbeat received for </span><span class="si">%.1f</span><span class="s2">s - Leaf FC connection lost&quot;</span><span class="p">,</span>
                                          <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_leaf_fc_heartbeat_time</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">leaf_fc_connected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Leaf FC heartbeat received for </span><span class="si">%.1f</span><span class="s2">s - still disconnected&quot;</span><span class="p">,</span>
                                          <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_leaf_fc_heartbeat_time</span><span class="p">)</span>
                                
                <span class="c1"># Check if we haven&#39;t received a heartbeat recently</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_timeout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No heartbeat received for </span><span class="si">%.1f</span><span class="s2">s - connection lost&quot;</span><span class="p">,</span>
                                        <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No heartbeat received for </span><span class="si">%.1f</span><span class="s2">s - still disconnected&quot;</span><span class="p">,</span>
                                        <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_heartbeat_time</span><span class="p">)</span>
                
                <span class="c1"># Attempt reconnection if not connected - BUT only if no FTP operations are in progress</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="c1"># Double-check that no FTP operations are running before attempting reconnection</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Delaying reconnection - FTP operation in progress&quot;</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_check_interval</span><span class="p">)</span>
                        <span class="k">continue</span>
                        
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to reconnect to MAVLink...&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_establish_connection</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_interval</span><span class="p">)</span>
                
                <span class="c1"># Check connection health periodically</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connection_check_interval</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in connection monitor: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_interval</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_schedule_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called from the FTP thread when it detects a dead FD.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># avoid stampeding: only schedule once</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_reconnect_pending&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_pending</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_task</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Wait for any ongoing FTP operations to complete before reconnecting</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for FTP operations to complete before reconnecting...&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                    
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_establish_connection</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># force a fresh BlockingParser next time only on failure</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_pending</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">_task</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_heartbeat_periodically</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Periodically send a MAVLink heartbeat message.&quot;&quot;&quot;</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">frequency</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_running</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_heartbeat</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping heartbeat send - not connected&quot;</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send heartbeat: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Don&#39;t mark as disconnected just for heartbeat send failure</span>
                
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

<div class="viewcode-block" id="MavLinkExternalProxy.send_heartbeat">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.send_heartbeat">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a MAVLink heartbeat message.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink master not initialized&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink not connected&quot;</span><span class="p">)</span>
        
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">heartbeat_encode</span><span class="p">(</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_TYPE_GCS</span><span class="p">,</span>  <span class="c1"># GCS type</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_AUTOPILOT_INVALID</span><span class="p">,</span>  <span class="c1"># Autopilot type</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Base mode</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Custom mode</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_STATE_ACTIVE</span>  <span class="c1"># System state</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sent MAVLink heartbeat&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.stop">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.stop">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the worker and close the link.&quot;&quot;&quot;</span>
        <span class="c1"># Cancel monitoring tasks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_monitor_task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection_monitor_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_monitor_task</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heartbeat_task</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Stop the worker thread</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        
        <span class="c1"># Close MAVLink connection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="c1"># ------------------- I/O primitives --------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_io_read_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">recv_match</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
            
                <span class="n">msg_type</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span>
                <span class="n">msg_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_msgId</span><span class="p">()</span>
                
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">msg_id</span><span class="p">),</span> <span class="n">msg</span><span class="p">))</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">msg_type</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle connection errors gracefully</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAVLink connection lost during read: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Don&#39;t mark as disconnected here, let the heartbeat monitor handle it</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error reading MAVLink messages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading MAVLink messages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Don&#39;t mark as disconnected here, let the heartbeat monitor handle it</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_io_write_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send queued MAVLink messages.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">msgs</span> <span class="ow">in</span> <span class="n">batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg_type</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;get_type&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;UNKNOWN&#39;</span>
                    <span class="n">msg_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_msgId</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;get_msgId&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
                    
                    <span class="c1"># Only log if rate limiting allows</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_log_message</span><span class="p">(</span><span class="n">msg_type</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📤 MAVLink TX: </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2"> (ID: </span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPIPE</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAVLink connection lost during write: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Don&#39;t mark as disconnected here, let the heartbeat monitor handle it</span>
                        <span class="k">break</span>  <span class="c1"># Stop trying to send more messages</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error sending MAVLink message </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_msgs</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to send MAVLink message </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">exc</span>
                    <span class="p">)</span>
                    <span class="c1"># Don&#39;t mark as disconnected here, let the heartbeat monitor handle it</span>

    <span class="c1"># ------------------- helpers exposed to petals --------- #</span>
<div class="viewcode-block" id="MavLinkExternalProxy.build_req_msg_long">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_req_msg_long">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_req_msg_long</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_command_long_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a MAVLink command to request a specific message type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message_id : int</span>
<span class="sd">            The numeric ID of the MAVLink message to request.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mavutil.mavlink.MAVLink_command_long_message</span>
<span class="sd">            The MAVLink command message to request the specified message.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>
                                
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">command_long_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_REQUEST_MESSAGE</span><span class="p">,</span> 
            <span class="mi">0</span><span class="p">,</span>                <span class="c1"># confirmation</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">message_id</span><span class="p">),</span> <span class="c1"># param1: Message ID to be streamed</span>
            <span class="mi">0</span><span class="p">,</span> 
            <span class="mi">0</span><span class="p">,</span> 
            <span class="mi">0</span><span class="p">,</span> 
            <span class="mi">0</span><span class="p">,</span> 
            <span class="mi">0</span><span class="p">,</span> 
            <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_req_msg_log_request">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_req_msg_log_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_req_msg_log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_log_request_list_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a MAVLink command to request a specific log message.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message_id : int</span>
<span class="sd">            The numeric ID of the log message to request.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mavutil.mavlink.MAVLink_log_request_list_message</span>
<span class="sd">            The MAVLink command message to request the specified log.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">log_request_list_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>                     <span class="c1"># start id</span>
            <span class="mh">0xFFFF</span>                 <span class="c1"># end id</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cmd</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_req_msg_log_data">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_req_msg_log_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_req_msg_log_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ofs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_log_request_data_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build LOG_REQUEST_DATA for a given log.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log_id : int</span>
<span class="sd">            The log id from LOG_ENTRY.id</span>
<span class="sd">        ofs : int</span>
<span class="sd">            Offset into the log (usually 0 for first request)</span>
<span class="sd">        count : int</span>
<span class="sd">            Number of bytes requested. For PX4/ArduPilot it&#39;s common</span>
<span class="sd">            to use 0xFFFFFFFF to say &quot;send the whole log&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">log_request_data_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">log_id</span><span class="p">,</span>
            <span class="n">ofs</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_param_request_read">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_param_request_read">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_param_request_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build MAVLink PARAM_REQUEST_READ for a named or indexed parameter.</span>
<span class="sd">        If index == -1, the &#39;name&#39; is used; otherwise PX4 will ignore name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="c1"># pymavlink will pad/trim to 16 chars; PX4 expects ASCII</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">param_request_read_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span>
            <span class="n">index</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_param_request_list">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_param_request_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_param_request_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build MAVLink PARAM_REQUEST_LIST to fetch the full table.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">param_request_list_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_param_set">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_param_set">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_param_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">param_type</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build MAVLink PARAM_SET for setting a parameter.</span>
<span class="sd">        Handles INT32 encoding where int32 values are encoded as float32 bits for wire transmission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>
        
        <span class="c1"># Use the encoding method for proper INT32 handling</span>
        <span class="n">encoded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_param_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">param_type</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">param_set_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span>
            <span class="n">encoded_value</span><span class="p">,</span>               <span class="c1"># properly encoded value</span>
            <span class="n">param_type</span>                   <span class="c1"># mavutil.mavlink.MAV_PARAM_TYPE_*</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_reboot_command">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_reboot_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_reboot_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reboot_autopilot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">reboot_onboard_computer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_command_long_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a MAVLink command to reboot the autopilot and/or onboard computer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reboot_autopilot : bool</span>
<span class="sd">            If True, reboot the autopilot (PX4/ArduPilot). Default is True.</span>
<span class="sd">        reboot_onboard_computer : bool</span>
<span class="sd">            If True, reboot the onboard computer. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mavutil.mavlink.MAVLink_command_long_message</span>
<span class="sd">            The MAVLink COMMAND_LONG message for reboot.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="c1"># param1: 1=reboot autopilot, 0=do nothing</span>
        <span class="c1"># param2: 1=reboot onboard computer, 0=do nothing</span>
        <span class="n">param1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">reboot_autopilot</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">param2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">reboot_onboard_computer</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">command_long_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>       <span class="c1"># confirmation</span>
            <span class="n">param1</span><span class="p">,</span>  <span class="c1"># param1: reboot autopilot</span>
            <span class="n">param2</span><span class="p">,</span>  <span class="c1"># param2: reboot onboard computer</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>  <span class="c1"># param3..param7 unused</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_format_storage_command">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_format_storage_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_format_storage_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">storage_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_command_long_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a MAVLink command to format the SD card (MAV_CMD_PREFLIGHT_STORAGE).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        storage_id : int</span>
<span class="sd">            Storage device ID (0 = primary SD card). Default is 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mavutil.mavlink.MAVLink_command_long_message</span>
<span class="sd">            The MAVLink COMMAND_LONG message for format storage.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">command_long_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_PREFLIGHT_STORAGE</span><span class="p">,</span>  <span class="c1"># 245</span>
            <span class="mi">0</span><span class="p">,</span>                  <span class="c1"># confirmation</span>
            <span class="mi">2</span><span class="p">,</span>                  <span class="c1"># param1: 2 = format</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">storage_id</span><span class="p">),</span>  <span class="c1"># param2: storage id / device</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>      <span class="c1"># param3..param7 unused</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.format_sd_card">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.format_sd_card">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">format_sd_card</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">storage_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FormatStorageResponse&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a format storage command to the autopilot and wait for ACK.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        storage_id : int</span>
<span class="sd">            Storage device ID (0 = primary SD card). Default is 0.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Maximum time to wait for acknowledgment. Default is 10.0 seconds</span>
<span class="sd">            (formatting can take a few seconds).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FormatStorageResponse</span>
<span class="sd">            Structured response indicating success/failure and reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FormatStorageResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_NOT_CONNECTED</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;MAVLink connection not established.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_format_storage_command</span><span class="p">(</span><span class="n">storage_id</span><span class="o">=</span><span class="n">storage_id</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ack_received&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;COMMAND_ACK&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_PREFLIGHT_STORAGE</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ack_received&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">result</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">COMMAND_ACK_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_COMMAND_ACK</span><span class="p">)</span>

        <span class="n">_ACK_TO_STATUS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_DENIED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_TEMPORARILY_REJECTED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_UNSUPPORTED</span><span class="p">:</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_UNSUPPORTED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_FAILED</span><span class="p">:</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_FAILED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_IN_PROGRESS</span><span class="p">:</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_IN_PROGRESS</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="p">,</span> <span class="s2">&quot;MAV_RESULT_CANCELLED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_CANCELLED</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">_ACK_NAME</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_ACCEPTED</span><span class="p">:</span> <span class="s2">&quot;ACCEPTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span> <span class="s2">&quot;TEMPORARILY_REJECTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span> <span class="s2">&quot;DENIED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_UNSUPPORTED</span><span class="p">:</span> <span class="s2">&quot;UNSUPPORTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_FAILED</span><span class="p">:</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_IN_PROGRESS</span><span class="p">:</span> <span class="s2">&quot;IN_PROGRESS&quot;</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="p">,</span> <span class="s2">&quot;MAV_RESULT_CANCELLED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span> <span class="s2">&quot;CANCELLED&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
                <span class="n">match_key</span><span class="o">=</span><span class="n">COMMAND_ACK_ID</span><span class="p">,</span>
                <span class="n">request_msg</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span>
                <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Format storage command sent but no ACK received within timeout.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FormatStorageResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_TIMEOUT</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;No ACK received within </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s timeout.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># ACK path</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ack_received&quot;</span><span class="p">]:</span>
            <span class="n">ack_val</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
            <span class="n">ack_name</span> <span class="o">=</span> <span class="n">_ACK_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack_val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;UNKNOWN(</span><span class="si">{</span><span class="n">ack_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ack_val</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_ACCEPTED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Format storage command accepted by autopilot&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">FormatStorageResponse</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">OK_ACK_ACCEPTED</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Autopilot acknowledged the format storage command (ACCEPTED).&quot;</span><span class="p">,</span>
                    <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">_ACK_TO_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack_val</span><span class="p">,</span> <span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_UNKNOWN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Format storage command rejected with result: </span><span class="si">{</span><span class="n">ack_val</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ack_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FormatStorageResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autopilot rejected the format storage command: </span><span class="si">{</span><span class="n">ack_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Rare: send_and_wait returned without TimeoutError but collector never matched</span>
        <span class="k">return</span> <span class="n">FormatStorageResponse</span><span class="p">(</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">FormatStorageStatusCode</span><span class="o">.</span><span class="n">FAIL_NO_ACK_MATCH</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;send_and_wait returned but no matching COMMAND_ACK for format storage was observed.&quot;</span><span class="p">,</span>
            <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_motor_value_command">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_motor_value_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_motor_value_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">motor_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">motor_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_command_long_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build MAV_CMD_ACTUATOR_TEST command for a motor.&quot;&quot;&quot;</span>                    
        <span class="c1"># param1 = throttle value (0-1 or NaN)</span>
        <span class="c1"># param2 = timeout in seconds</span>
        <span class="c1"># param5 = motor mapping (110x where x is motor index</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">command_long_encode</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="c1"># TODO: investigate best practice</span>
            <span class="mi">1</span><span class="p">,</span> <span class="c1"># TODO: investigate best practice</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_ACTUATOR_TEST</span><span class="p">,</span> 
            <span class="mi">0</span><span class="p">,</span>                          <span class="c1"># confirmation</span>
            <span class="n">motor_value</span><span class="p">,</span>                <span class="c1"># param1: Motor value (0-1 or NaN)</span>
            <span class="n">timeout</span><span class="p">,</span>                    <span class="c1"># param2: Timeout in seconds</span>
            <span class="mi">0</span><span class="p">,</span>                          <span class="c1"># Reserved</span>
            <span class="mi">0</span><span class="p">,</span>                          <span class="c1"># Reserved    </span>
            <span class="nb">float</span><span class="p">(</span><span class="mi">1100</span> <span class="o">+</span> <span class="n">motor_idx</span><span class="p">),</span>    <span class="c1"># param5: Motor mapping (110x)</span>
            <span class="mi">0</span><span class="p">,</span>                          <span class="c1"># Reserved</span>
            <span class="mi">0</span>                           <span class="c1"># Reserved</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_request_message_command">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_request_message_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_request_message_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_command_long_message</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a MAVLink command to request a specific message once</span>
<span class="sd">        using MAV_CMD_REQUEST_MESSAGE (common.xml).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mavutil.mavlink.MAVLink_command_long_message</span>
<span class="sd">            The MAVLink COMMAND_LONG message requesting the given message.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">command_long_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_REQUEST_MESSAGE</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>                 <span class="c1"># confirmation</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_SYSTEM_TIME</span><span class="p">),</span> <span class="c1"># param1: requested message id</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>   <span class="c1"># param2..param7 unused</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.build_shell_serial_control_msgs">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.build_shell_serial_control_msgs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_shell_serial_control_msgs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>   <span class="c1"># PX4 mavlink_shell.py uses devnum=10</span>
        <span class="n">respond</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_serial_control_message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build SERIAL_CONTROL messages that write `text` to the PX4 MAVLink shell.</span>
<span class="sd">        Splits into &lt;=70 byte chunks (MAVLink SERIAL_CONTROL data field).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        text : str</span>
<span class="sd">            The text to send to the MAVLink shell.</span>
<span class="sd">        device : int</span>
<span class="sd">            The device number to use (default 10 for PX4 mavlink_shell).</span>
<span class="sd">        respond : bool</span>
<span class="sd">            If True, set the RESPOND flag (default True).</span>
<span class="sd">        exclusive : bool</span>
<span class="sd">            If True, set the EXCLUSIVE flag (default True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">respond</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">SERIAL_CONTROL_FLAG_RESPOND</span>
        <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">SERIAL_CONTROL_FLAG_EXCLUSIVE</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># MAVLink shell implementation chunks at 70 bytes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">70</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">70</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">70</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">serial_control_encode</span><span class="p">(</span>
                    <span class="n">device</span><span class="p">,</span>     <span class="c1"># device</span>
                    <span class="n">flags</span><span class="p">,</span>      <span class="c1"># flags</span>
                    <span class="mi">0</span><span class="p">,</span>          <span class="c1"># timeout (PX4 ignores it)</span>
                    <span class="mi">0</span><span class="p">,</span>          <span class="c1"># baudrate (0 = no change)</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">),</span> <span class="c1"># count</span>
                    <span class="n">data</span><span class="p">,</span>       <span class="c1"># data[70]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">msgs</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.send_shell_command">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.send_shell_command">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_shell_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">settle_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a shell command to PX4 via MAVLink SERIAL_CONTROL and wait</span>
<span class="sd">        for PX4 to acknowledge it.</span>

<span class="sd">        Uses :py:meth:`send_and_wait` so the command is transmitted through</span>
<span class="sd">        the normal I/O queue **and** we block until PX4 replies with at</span>
<span class="sd">        least one ``SERIAL_CONTROL`` packet (flag ``REPLY``), confirming</span>
<span class="sd">        the shell received the command.  A *settle_time* pause is added</span>
<span class="sd">        afterwards so PX4 has time to act on it (e.g. release file</span>
<span class="sd">        handles).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        command : str</span>
<span class="sd">            The shell command to send (e.g. ``&quot;logger stop\\n&quot;``).</span>
<span class="sd">        settle_time : float</span>
<span class="sd">            Extra time (seconds) to wait **after** PX4 acknowledges the</span>
<span class="sd">            command, giving it time to act (e.g. close file handles).</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Maximum time (seconds) to wait for a reply before raising</span>
<span class="sd">            ``TimeoutError``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The text content of the first SERIAL_CONTROL reply from PX4,</span>
<span class="sd">            or an empty string if no reply was received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">msgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_shell_serial_control_msgs</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msgs</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># We only need to send_and_wait on the *last* chunk; PX4 will</span>
        <span class="c1"># reply once it has the full command (terminated by \n).</span>
        <span class="c1"># Send all chunks except the last one directly.</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="n">serial_control_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_SERIAL_CONTROL</span><span class="p">)</span>

        <span class="n">reply_received</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reply_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return True once we get any SERIAL_CONTROL reply from PX4.&quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">reply_received</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="s2">&quot;flags&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">SERIAL_CONTROL_FLAG_REPLY</span><span class="p">:</span>
                <span class="c1"># Capture reply text for diagnostics</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">reply_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="nb">bytes</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">count</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">reply_received</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
                <span class="n">match_key</span><span class="o">=</span><span class="n">serial_control_id</span><span class="p">,</span>
                <span class="n">request_msg</span><span class="o">=</span><span class="n">msgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">reply_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reply_chunks</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shell command </span><span class="si">{</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> acknowledged by PX4&quot;</span>
                <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; — reply: </span><span class="si">{</span><span class="n">reply_text</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">reply_text</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="n">reply_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No SERIAL_CONTROL reply for shell command &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">!r}</span><span class="s2"> within </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s — &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;proceeding anyway (command may still have been received)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Give PX4 time to act on the command (e.g. release file handles)</span>
        <span class="k">if</span> <span class="n">settle_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">settle_time</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">reply_text</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.stop_px4_logging">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.stop_px4_logging">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop_px4_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settle_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop PX4&#39;s SD-card logger so that log files can be deleted.</span>

<span class="sd">        Sends ``logger stop\\n`` via the MAVLink shell and waits for PX4</span>
<span class="sd">        to acknowledge.  The logger module releases its file handles,</span>
<span class="sd">        making files deletable via MAVFTP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping PX4 logger to allow file deletion…&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_shell_command</span><span class="p">(</span><span class="s2">&quot;logger stop</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">settle_time</span><span class="o">=</span><span class="n">settle_time</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PX4 logger stopped.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.start_px4_logging">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.start_px4_logging">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_px4_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settle_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart PX4&#39;s SD-card logger after file operations.</span>

<span class="sd">        Sends ``logger start\\n`` via the MAVLink shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restarting PX4 logger…&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_shell_command</span><span class="p">(</span><span class="s2">&quot;logger start</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">settle_time</span><span class="o">=</span><span class="n">settle_time</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PX4 logger restarted.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.delete_file_via_shell">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.delete_file_via_shell">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_file_via_shell</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rm&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a file (or empty directory) on PX4 using a NuttX shell command.</span>

<span class="sd">        This is a fallback for when MAVFTP ``cmd_rm`` fails with</span>
<span class="sd">        ``FileProtected`` (code 9).  The shell ``rm`` bypasses the</span>
<span class="sd">        MAVFTP server&#39;s protection checks and deletes the file</span>
<span class="sd">        directly via NuttX ``unlink()``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote_path : str</span>
<span class="sd">            Full path on the vehicle, e.g.</span>
<span class="sd">            ``&quot;fs/microsd/log/2025-09-01/07_50_39.ulg&quot;``.</span>
<span class="sd">            The path must start without a leading ``/``.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Maximum seconds to wait for PX4 shell acknowledgment.</span>
<span class="sd">        command : str</span>
<span class="sd">            NuttX shell command to use.  ``&quot;rm&quot;`` for files,</span>
<span class="sd">            ``&quot;rmdir&quot;`` for empty directories.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            ``True`` if the command completed (no error detected in</span>
<span class="sd">            the reply text), ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NuttX rm/rmdir expects an absolute path starting with /</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="n">remote_path</span> <span class="k">if</span> <span class="n">remote_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shell </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> fallback: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_shell_command</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">settle_time</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
            <span class="p">)</span>
            <span class="c1"># NuttX rm prints nothing on success; on error it prints</span>
            <span class="c1"># something like &quot;rm: /path: No such file or directory&quot;</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="s2">&quot;no such&quot;</span> <span class="ow">in</span> <span class="n">lower</span>
                <span class="ow">or</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">lower</span>
                <span class="ow">or</span> <span class="s2">&quot;failed&quot;</span> <span class="ow">in</span> <span class="n">lower</span>
                <span class="ow">or</span> <span class="s2">&quot;invalid&quot;</span> <span class="ow">in</span> <span class="n">lower</span>
                <span class="ow">or</span> <span class="s2">&quot;not empty&quot;</span> <span class="ow">in</span> <span class="n">lower</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Shell </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2"> returned error: </span><span class="si">{</span><span class="n">reply</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shell </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> completed for </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shell </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> failed for </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.reboot_autopilot">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.reboot_autopilot">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reboot_autopilot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reboot_onboard_computer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RebootAutopilotResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a reboot command to the autopilot (PX4/ArduPilot).</span>

<span class="sd">        This sends MAV_CMD_PREFLIGHT_REBOOT_SHUTDOWN and waits for a</span>
<span class="sd">        COMMAND_ACK response.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reboot_onboard_computer : bool</span>
<span class="sd">            If True, also reboot the onboard computer. Default is False.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Maximum time to wait for acknowledgment. Default is 3.0 seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RebootAutopilotResponse</span>
<span class="sd">            Structured response indicating success/failure and reason.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If no acknowledgment is received within the timeout.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        After sending this command, the connection to the autopilot will be lost</span>
<span class="sd">        as it reboots. The proxy will attempt to reconnect automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_reboot_command</span><span class="p">(</span>
            <span class="n">reboot_autopilot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reboot_onboard_computer</span><span class="o">=</span><span class="n">reboot_onboard_computer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ack_received&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;COMMAND_ACK&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ack_received&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">result</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">COMMAND_ACK_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_COMMAND_ACK</span><span class="p">)</span>

        <span class="c1"># Map ACK result codes -&gt; status codes (for failures)</span>
        <span class="n">_ACK_TO_STATUS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_DENIED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_TEMPORARILY_REJECTED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_UNSUPPORTED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_UNSUPPORTED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_FAILED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_FAILED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_IN_PROGRESS</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_IN_PROGRESS</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="p">,</span> <span class="s2">&quot;MAV_RESULT_CANCELLED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_CANCELLED</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">_ACK_NAME</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_ACCEPTED</span><span class="p">:</span> <span class="s2">&quot;ACCEPTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span> <span class="s2">&quot;TEMPORARILY_REJECTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span> <span class="s2">&quot;DENIED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_UNSUPPORTED</span><span class="p">:</span> <span class="s2">&quot;UNSUPPORTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_FAILED</span><span class="p">:</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_IN_PROGRESS</span><span class="p">:</span> <span class="s2">&quot;IN_PROGRESS&quot;</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="p">,</span> <span class="s2">&quot;MAV_RESULT_CANCELLED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span> <span class="s2">&quot;CANCELLED&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
                <span class="n">match_key</span><span class="o">=</span><span class="n">COMMAND_ACK_ID</span><span class="p">,</span>
                <span class="n">request_msg</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span>
                <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="c1"># No ACK: verify reboot using heartbeat timestamps (populated by your heartbeat handler)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Reboot command sent but no ACK received; verifying via heartbeat drop/return...&quot;</span>
            <span class="p">)</span>

            <span class="n">last_hb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_hb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No heartbeat timestamp available (_last_heartbeat_time is None); reboot not confirmed.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_NO_HEARTBEAT_TRACKING</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;No ACK received and heartbeat tracking is unavailable (_last_heartbeat_time is None).&quot;</span><span class="p">,</span>
                    <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_heartbeat_drop</span><span class="p">(</span>
                <span class="n">wait_window_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="n">gap_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">poll_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">wait_window_s</span>
                <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">gap_s</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_s</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_heartbeat_return</span><span class="p">(</span>
                <span class="n">since_ts</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">wait_window_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
                <span class="n">poll_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">wait_window_s</span>
                <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="n">since_ts</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_s</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">dropped</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_wait_for_heartbeat_drop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dropped</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No ACK and no heartbeat drop observed; reboot not confirmed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_REBOOT_NOT_CONFIRMED_NO_HB_DROP</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;No ACK received and heartbeat did not drop within the expected window.&quot;</span><span class="p">,</span>
                    <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">drop_mark</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="n">last_hb</span><span class="p">)</span> <span class="ow">or</span> <span class="n">last_hb</span>

            <span class="n">returned</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_wait_for_heartbeat_return</span><span class="p">(</span><span class="n">since_ts</span><span class="o">=</span><span class="n">drop_mark</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">returned</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Heartbeat dropped but did not return within the reboot window; reboot not confirmed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_REBOOT_NOT_CONFIRMED_HB_NO_RETURN</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Heartbeat drop observed but heartbeat did not return within the reboot window.&quot;</span><span class="p">,</span>
                    <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reboot confirmed via heartbeat drop + return.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">OK_REBOOT_CONFIRMED_NO_ACK</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;No ACK received, but reboot confirmed via heartbeat drop + return.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># ACK path</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ack_received&quot;</span><span class="p">]:</span>
            <span class="n">ack_val</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
            <span class="n">ack_name</span> <span class="o">=</span> <span class="n">_ACK_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack_val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;UNKNOWN(</span><span class="si">{</span><span class="n">ack_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ack_val</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_ACCEPTED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reboot command accepted by autopilot&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                    <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">OK_ACK_ACCEPTED</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Autopilot acknowledged the reboot command (ACCEPTED).&quot;</span><span class="p">,</span>
                    <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">_ACK_TO_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack_val</span><span class="p">,</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_UNKNOWN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reboot command rejected with result: </span><span class="si">{</span><span class="n">ack_val</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ack_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autopilot rejected the reboot command: </span><span class="si">{</span><span class="n">ack_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Rare: send_and_wait returned without TimeoutError but collector never matched</span>
        <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_NO_ACK_MATCH</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;send_and_wait returned but no matching COMMAND_ACK for reboot command was observed.&quot;</span><span class="p">,</span>
            <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.reboot_autopilot_confirmed">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.reboot_autopilot_confirmed">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reboot_autopilot_confirmed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reboot_onboard_computer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ack_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">hb_drop_window_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">hb_drop_gap_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">hb_return_window_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
        <span class="n">hb_poll_interval_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">sitl_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RebootAutopilotResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a reboot command and confirm success via heartbeat drop + return.</span>

<span class="sd">        Unlike :meth:`reboot_autopilot`, heartbeat confirmation is the</span>
<span class="sd">        **primary** verification method, not a fallback.  The flow is:</span>

<span class="sd">        1. Send MAV_CMD_PREFLIGHT_REBOOT_SHUTDOWN and wait for COMMAND_ACK.</span>
<span class="sd">           - If the ACK is a rejection, return immediately with failure.</span>
<span class="sd">           - If the ACK is accepted *or* times out, proceed to step 2.</span>
<span class="sd">        2. Wait for heartbeat to **drop** (gap ≥ ``hb_drop_gap_s`` within</span>
<span class="sd">           ``hb_drop_window_s``).</span>
<span class="sd">        3. Wait for heartbeat to **return** (new heartbeat after the drop</span>
<span class="sd">           within ``hb_return_window_s``).</span>
<span class="sd">        4. Return success only when heartbeat returns, confirming the</span>
<span class="sd">           autopilot has rebooted and is alive again.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reboot_onboard_computer : bool</span>
<span class="sd">            If True, also reboot the onboard computer.</span>
<span class="sd">        ack_timeout : float</span>
<span class="sd">            Maximum time (s) to wait for COMMAND_ACK.</span>
<span class="sd">        hb_drop_window_s : float</span>
<span class="sd">            Time window (s) to detect heartbeat drop after command.</span>
<span class="sd">        hb_drop_gap_s : float</span>
<span class="sd">            Minimum gap (s) without a heartbeat to consider it dropped.</span>
<span class="sd">        hb_return_window_s : float</span>
<span class="sd">            Time window (s) to wait for heartbeat to return after drop.</span>
<span class="sd">        hb_poll_interval_s : float</span>
<span class="sd">            Polling interval (s) for heartbeat checks.</span>
<span class="sd">        sitl_mode : bool</span>
<span class="sd">            If True, treat a DENIED ACK as acceptable instead of failing</span>
<span class="sd">            immediately.  This allows SITL testing where the user manually</span>
<span class="sd">            kills and restarts the ``px4_sitl`` process to trigger the</span>
<span class="sd">            heartbeat drop + return cycle.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RebootAutopilotResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="c1"># ── Step 1: Send reboot command and attempt to get ACK ────────────</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_reboot_command</span><span class="p">(</span>
            <span class="n">reboot_autopilot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reboot_onboard_computer</span><span class="o">=</span><span class="n">reboot_onboard_computer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ack_received&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;COMMAND_ACK&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ack_received&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">result</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">COMMAND_ACK_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_COMMAND_ACK</span><span class="p">)</span>

        <span class="n">_ACK_TO_STATUS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_DENIED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_TEMPORARILY_REJECTED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_UNSUPPORTED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_UNSUPPORTED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_FAILED</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_FAILED</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_IN_PROGRESS</span><span class="p">:</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_IN_PROGRESS</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="p">,</span> <span class="s2">&quot;MAV_RESULT_CANCELLED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_CANCELLED</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">_ACK_NAME</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_ACCEPTED</span><span class="p">:</span> <span class="s2">&quot;ACCEPTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span> <span class="s2">&quot;TEMPORARILY_REJECTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span> <span class="s2">&quot;DENIED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_UNSUPPORTED</span><span class="p">:</span> <span class="s2">&quot;UNSUPPORTED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_FAILED</span><span class="p">:</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span>
            <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_IN_PROGRESS</span><span class="p">:</span> <span class="s2">&quot;IN_PROGRESS&quot;</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="p">,</span> <span class="s2">&quot;MAV_RESULT_CANCELLED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span> <span class="s2">&quot;CANCELLED&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">ack_received</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ack_val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
                <span class="n">match_key</span><span class="o">=</span><span class="n">COMMAND_ACK_ID</span><span class="p">,</span>
                <span class="n">request_msg</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span>
                <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">ack_timeout</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Reboot command sent but no ACK received; proceeding to heartbeat confirmation...&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ack_received&quot;</span><span class="p">]:</span>
            <span class="n">ack_received</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ack_val</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
            <span class="n">ack_name</span> <span class="o">=</span> <span class="n">_ACK_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack_val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;UNKNOWN(</span><span class="si">{</span><span class="n">ack_val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="c1"># If ACK is a rejection, fail immediately — no point waiting for heartbeat</span>
            <span class="c1"># Exception: in SITL mode, DENIED is expected (simulator cannot reboot)</span>
            <span class="c1"># so we skip the failure and proceed to heartbeat confirmation,</span>
            <span class="c1"># allowing the user to manually kill/restart px4_sitl.</span>
            <span class="k">if</span> <span class="n">ack_val</span> <span class="o">!=</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_ACCEPTED</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sitl_mode</span> <span class="ow">and</span> <span class="n">ack_val</span> <span class="o">==</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_RESULT_DENIED</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;SITL_MODE: Reboot ACK was DENIED (expected for SITL). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Proceeding to heartbeat confirmation — manually kill and &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;restart px4_sitl within </span><span class="si">{</span><span class="n">hb_drop_window_s</span><span class="si">}</span><span class="s2">s to trigger &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;heartbeat drop...&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">_ACK_TO_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack_val</span><span class="p">,</span> <span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_ACK_UNKNOWN</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reboot command rejected with result: </span><span class="si">{</span><span class="n">ack_val</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ack_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                        <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                        <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autopilot rejected the reboot command: </span><span class="si">{</span><span class="n">ack_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reboot command accepted by autopilot, proceeding to heartbeat confirmation...&quot;</span><span class="p">)</span>

        <span class="c1"># ── Step 2: Heartbeat drop confirmation (primary check) ───────────</span>
        <span class="n">last_hb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_hb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No heartbeat timestamp available; cannot confirm reboot via heartbeat.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_NO_HEARTBEAT_TRACKING</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Heartbeat tracking is unavailable (_last_heartbeat_time is None). Cannot confirm reboot.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_heartbeat_drop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">hb_drop_window_s</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">hb_drop_gap_s</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">hb_poll_interval_s</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">dropped</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_wait_for_heartbeat_drop</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dropped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Heartbeat did not drop within the expected window; reboot not confirmed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_REBOOT_NOT_CONFIRMED_NO_HB_DROP</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Heartbeat did not drop within </span><span class="si">{</span><span class="n">hb_drop_window_s</span><span class="si">}</span><span class="s2">s window &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(gap threshold: </span><span class="si">{</span><span class="n">hb_drop_gap_s</span><span class="si">}</span><span class="s2">s). Reboot not confirmed.&quot;</span>
                <span class="p">),</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">drop_mark</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="n">last_hb</span><span class="p">)</span> <span class="ow">or</span> <span class="n">last_hb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Heartbeat drop detected, waiting for heartbeat to return...&quot;</span><span class="p">)</span>

        <span class="c1"># ── Step 3: Heartbeat return confirmation ─────────────────────────</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_heartbeat_return</span><span class="p">(</span><span class="n">since_ts</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">hb_return_window_s</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_heartbeat_time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="n">since_ts</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">hb_poll_interval_s</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">returned</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_wait_for_heartbeat_return</span><span class="p">(</span><span class="n">since_ts</span><span class="o">=</span><span class="n">drop_mark</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">returned</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Heartbeat dropped but did not return; reboot not confirmed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">FAIL_REBOOT_NOT_CONFIRMED_HB_NO_RETURN</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Heartbeat drop observed but heartbeat did not return within &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hb_return_window_s</span><span class="si">}</span><span class="s2">s. Autopilot may still be rebooting.&quot;</span>
                <span class="p">),</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># ── Step 4: Confirmed ─────────────────────────────────────────────</span>
        <span class="k">if</span> <span class="n">ack_received</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reboot confirmed: ACK accepted + heartbeat drop + return.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">OK_ACK_ACCEPTED_HB_CONFIRMED</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Reboot confirmed: COMMAND_ACK accepted and heartbeat drop + return observed.&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="n">ack_val</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reboot confirmed via heartbeat drop + return (no ACK received).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RebootAutopilotResponse</span><span class="p">(</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">RebootStatusCode</span><span class="o">.</span><span class="n">OK_HB_CONFIRMED_NO_ACK</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Reboot confirmed via heartbeat drop + return (no COMMAND_ACK received).&quot;</span><span class="p">,</span>
                <span class="n">ack_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.get_param">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.get_param">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request a single PARAM_VALUE for `name` and return a dict:</span>
<span class="sd">        {&quot;name&quot;: str, &quot;value&quot;: Union[int,float], &quot;raw&quot;: float, &quot;type&quot;: int, &quot;count&quot;: int, &quot;index&quot;: int}</span>
<span class="sd">        Raises TimeoutError if no reply within timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_param_request_read</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;got&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="c1"># Ensure we only process PARAM_VALUE</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Use the decoding method for proper INT32 handling</span>
            <span class="n">pkt_name</span><span class="p">,</span> <span class="n">decoded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_param_value</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pkt_name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;got&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">pkt_name</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">decoded_value</span><span class="p">,</span>
                <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">param_value</span><span class="p">),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_type</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_count</span><span class="p">,</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_index</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># You dispatch by both msg ID string and type; using type keeps it readable.</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
            <span class="n">match_key</span><span class="o">=</span><span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">,</span>
            <span class="n">request_msg</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;got&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PARAM_VALUE received for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.get_all_params">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.get_all_params">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_all_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request entire parameter list and return:</span>
<span class="sd">        { &quot;&lt;NAME&gt;&quot;: {&quot;value&quot;: int|float, &quot;raw&quot;: float, &quot;type&quot;: int, &quot;index&quot;: int, &quot;count&quot;: int}, ... }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_param_request_list</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">expected_total</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_count</span>

            <span class="c1"># Use the decoding method for proper INT32 handling</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">decoded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_param_value</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_index</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="c1"># duplicate frame—ignore; can happen with lossy links</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_index</span><span class="p">))</span>

                <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">decoded_value</span><span class="p">,</span>
                    <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">param_value</span><span class="p">),</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_type</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_index</span><span class="p">,</span>
                    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_count</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Stop when we&#39;ve collected all expected params</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">])</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
            <span class="n">match_key</span><span class="o">=</span><span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">,</span>
            <span class="n">request_msg</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
            <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.set_param">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.set_param">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ptype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a parameter and confirm by reading back. `value` can be int or float.</span>
<span class="sd">        Returns the confirmed PARAM_VALUE dict (same shape as get_param()).</span>
<span class="sd">        </span>
<span class="sd">        Uses proper INT32 encoding where int32 values are encoded as float32 bits for wire transmission.</span>

<span class="sd">        &gt;&gt;&gt; [&quot;MAV_PARAM_TYPE&quot;] = {</span>
<span class="sd">        &gt;&gt;&gt;     [1] = &quot;MAV_PARAM_TYPE_UINT8&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [2] = &quot;MAV_PARAM_TYPE_INT8&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [3] = &quot;MAV_PARAM_TYPE_UINT16&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [4] = &quot;MAV_PARAM_TYPE_INT16&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [5] = &quot;MAV_PARAM_TYPE_UINT32&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [6] = &quot;MAV_PARAM_TYPE_INT32&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [7] = &quot;MAV_PARAM_TYPE_UINT64&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [8] = &quot;MAV_PARAM_TYPE_INT64&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [9] = &quot;MAV_PARAM_TYPE_REAL32&quot;,</span>
<span class="sd">        &gt;&gt;&gt;     [10] = &quot;MAV_PARAM_TYPE_REAL64&quot;,</span>
<span class="sd">        &gt;&gt;&gt; }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pick a MAV_PARAM_TYPE based on Python type (simple heuristic)</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT32</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL32</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported parameter type for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported parameter type for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Build the PARAM_SET message with proper encoding</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_param_set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ptype</span><span class="p">)</span>

        <span class="c1"># Send the parameter set command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
        
        <span class="c1"># Wait for confirmation by reading back the parameter</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="c1"># Fall back to an explicit read if the echo was missed</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.send_and_wait">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.send_and_wait">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_and_wait</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">match_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">request_msg</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_message</span><span class="p">,</span>
        <span class="n">collector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_message</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">queue_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transmit *request_msg*, register a handler on *match_key* and keep feeding</span>
<span class="sd">        incoming packets to *collector* until it returns **True** or *timeout* expires.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        match_key :</span>
<span class="sd">            The key used when the proxy dispatches inbound messages</span>
<span class="sd">            (numeric ID as string, e.g. `&quot;147&quot;`).</span>
<span class="sd">        request_msg :</span>
<span class="sd">            Encoded MAVLink message to send - COMMAND_LONG, LOG_REQUEST_LIST, ...</span>
<span class="sd">        collector :</span>
<span class="sd">            Callback that receives each matching packet.  Must return **True**</span>
<span class="sd">            once the desired condition is satisfied; returning **False** keeps</span>
<span class="sd">            waiting.</span>
<span class="sd">        timeout :</span>
<span class="sd">            Maximum seconds to block.</span>
<span class="sd">        queue_length :</span>
<span class="sd">            Optional maximum queue length for the handler. If the queue</span>
<span class="sd">            exceeds this length, older packets will be dropped. If None,</span>
<span class="sd">            the default queue length is used.</span>
<span class="sd">        cancel_event :</span>
<span class="sd">            Optional threading.Event that can be set to cancel the wait.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If no matching response is received within the timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">done</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[collector] raised: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">match_key</span><span class="p">,</span> 
            <span class="n">fn</span> <span class="o">=</span> <span class="n">_handler</span><span class="p">,</span> 
            <span class="n">queue_length</span> <span class="o">=</span> <span class="n">queue_length</span>
        <span class="p">)</span>

        <span class="c1"># send the request message after registering the handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">request_msg</span><span class="p">)</span>

        <span class="c1"># create an asyncio task to monitor cancel_event if provided</span>
        <span class="k">if</span> <span class="n">cancel_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_cancel_checker</span><span class="p">():</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">cancel_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">done</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="n">cancel_checker</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_cancel_checker</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_mavlink_send_and_wait_cancel_checker&quot;</span><span class="p">)</span>
            <span class="n">cancel_checker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">done</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No reply/condition for </span><span class="si">{</span><span class="n">match_key</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cancel_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cancel_checker</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregister_handler</span><span class="p">(</span><span class="n">match_key</span><span class="p">,</span> <span class="n">_handler</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.get_log_entries">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.get_log_entries">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_log_entries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">msg_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">request_msg</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_message</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">8.0</span><span class="p">,</span>
        <span class="n">stale_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send LOG_REQUEST_LIST and gather all LOG_ENTRY packets.</span>

<span class="sd">        Handles two edge cases that PX4 firmware exhibits:</span>

<span class="sd">        1. **No logs on the vehicle** — PX4 responds with a single</span>
<span class="sd">           ``LOG_ENTRY`` where ``num_logs == 0``.  The MAVLink spec</span>
<span class="sd">           requires this sentinel packet; we detect it and return an</span>
<span class="sd">           empty dict immediately instead of waiting for the timeout.</span>

<span class="sd">        2. **Corrupted / missing log entries** — PX4 may advertise</span>
<span class="sd">           ``num_logs = N`` but only deliver fewer than *N*</span>
<span class="sd">           ``LOG_ENTRY`` packets (corrupted slots are silently</span>
<span class="sd">           skipped).  A staleness timer (``stale_timeout``) detects</span>
<span class="sd">           when no new entry has arrived for a while and returns</span>
<span class="sd">           whatever was collected so far.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg_id : str</span>
<span class="sd">            The MAVLink message ID string for LOG_ENTRY (e.g. ``&quot;118&quot;``).</span>
<span class="sd">        request_msg : mavutil.mavlink.MAVLink_message</span>
<span class="sd">            The encoded LOG_REQUEST_LIST message to send.</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Hard upper-bound on how long to wait (seconds).</span>
<span class="sd">        stale_timeout : float</span>
<span class="sd">            If no new LOG_ENTRY arrives within this many seconds</span>
<span class="sd">            *after* the first one, collection stops early and whatever</span>
<span class="sd">            entries were gathered are returned.  Only applies when</span>
<span class="sd">            ``num_logs &gt; 0`` and fewer than ``num_logs`` entries have</span>
<span class="sd">            been received.  Default 2.0 s.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[int, Dict[str, int]]</span>
<span class="sd">            ``{log_id: {&quot;size&quot;: int, &quot;utc&quot;: int}, …}``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expected_total</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">last_entry_time</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">num_logs</span>

            <span class="c1"># ── No logs on the vehicle ────────────────────────────────</span>
            <span class="c1"># PX4 sends LOG_ENTRY(id=0, num_logs=0) as a sentinel.</span>
            <span class="k">if</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Vehicle reports num_logs=0 — no logs on SD card.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># signal done immediately</span>

            <span class="n">entries</span><span class="p">[</span><span class="n">pkt</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;utc&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">time_utc</span><span class="p">}</span>
            <span class="n">last_entry_time</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>

        <span class="c1"># ── Staleness monitor ─────────────────────────────────────────</span>
        <span class="c1"># If PX4 stops sending LOG_ENTRY packets before we reach the</span>
        <span class="c1"># advertised num_logs (e.g. corrupted logs), the collector will</span>
        <span class="c1"># never return True and we&#39;d wait the full timeout.  This task</span>
        <span class="c1"># detects the stall and signals completion early via cancel_event.</span>
        <span class="n">cancel_evt</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stale_watchdog</span><span class="p">():</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">cancel_evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_entry_time</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">stale_timeout</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">got</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
                        <span class="n">want</span> <span class="o">=</span> <span class="n">expected_total</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;LOG_ENTRY stream stalled — received </span><span class="si">{</span><span class="n">got</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">want</span><span class="si">}</span><span class="s2"> entries &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(no new entry for </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s). &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Returning partial results; </span><span class="si">{</span><span class="n">want</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">got</span><span class="si">}</span><span class="s2"> entries may be corrupted/missing.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">cancel_evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>  <span class="c1"># unblocks send_and_wait</span>

        <span class="n">watchdog_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_stale_watchdog</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
                <span class="n">match_key</span><span class="o">=</span><span class="n">msg_id</span><span class="p">,</span>
                <span class="n">request_msg</span><span class="o">=</span><span class="n">request_msg</span><span class="p">,</span>
                <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">cancel_event</span><span class="o">=</span><span class="n">cancel_evt</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="c1"># If we collected *some* entries before the hard timeout, return</span>
            <span class="c1"># them instead of propagating the error.</span>
            <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
                <span class="n">got</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
                <span class="n">want</span> <span class="o">=</span> <span class="n">expected_total</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Hard timeout (</span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s) reached while collecting LOG_ENTRY packets. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Returning </span><span class="si">{</span><span class="n">got</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">want</span><span class="si">}</span><span class="s2"> entries collected so far.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>  <span class="c1"># genuinely got nothing — let caller handle it</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cancel_evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">watchdog_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">watchdog_task</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">entries</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_request_chunk</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">ofs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
            <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_log_data_message</span><span class="p">:</span>

        <span class="n">LOG_DATA_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_LOG_DATA</span><span class="p">)</span>

        <span class="c1"># Holder for this specific chunk</span>
        <span class="n">holder_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="n">holder</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLink_log_data_message</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collector</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="c1"># Only accept LOG_DATA for the correct log id</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">log_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Enforce the expected offset to avoid eating someone else&#39;s chunk</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">ofs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ofs</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="k">with</span> <span class="n">holder_lock</span><span class="p">:</span>
                <span class="n">holder</span><span class="p">[</span><span class="s2">&quot;pkt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Build LOG_REQUEST_DATA for *this* chunk</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">log_request_data_encode</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">log_id</span><span class="p">,</span>
            <span class="n">ofs</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Try a few times per chunk</span>
        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_and_wait</span><span class="p">(</span>
                    <span class="n">match_key</span><span class="o">=</span><span class="n">LOG_DATA_ID</span><span class="p">,</span>
                    <span class="n">request_msg</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                    <span class="n">collector</span><span class="o">=</span><span class="n">_collector</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">break</span>  <span class="c1"># got the chunk</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Timeout while waiting for LOG_DATA &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;log_id=</span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Timeout for LOG_DATA (log_id=</span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">, ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2">), &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;retry </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># re-send the same request and loop again</span>

        <span class="k">return</span> <span class="n">holder</span><span class="p">[</span><span class="s2">&quot;pkt&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_request_log_sync</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">completed_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">size_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_of_buffer_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronous helper: request LOG_DATA for a given log_id and return raw bytes.</span>
<span class="sd">        Assembles data by offset so out-of-order / duplicate packets are tolerated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to download Log ID: </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 1) Send LOG_REQUEST_DATA (from offset 0, full log)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">mav</span><span class="o">.</span><span class="n">log_request_data_send</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span><span class="p">,</span>
            <span class="n">log_id</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>          <span class="c1"># offset</span>
            <span class="mh">0xFFFFFFFF</span>  <span class="c1"># count: all data from offset</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested data for Log ID </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">, waiting for data...&quot;</span><span class="p">)</span>

        <span class="c1"># Chunks keyed by offset</span>
        <span class="n">received_chunks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">max_end</span> <span class="o">=</span> <span class="mi">0</span>                       <span class="c1"># highest offset+length we&#39;ve seen</span>
        <span class="n">total_unique_bytes</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># bytes from non-duplicate chunks</span>

        <span class="n">completed_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">last_data_time</span> <span class="o">=</span> <span class="n">start_time</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Global timeout</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout while downloading log data (global timeout).&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Log data download timed out.&quot;</span><span class="p">)</span>

                <span class="c1"># End-of-buffer timeout (only after we&#39;ve actually received something)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">end_of_buffer_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">total_unique_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_data_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">end_of_buffer_timeout</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No new data for </span><span class="si">{</span><span class="n">end_of_buffer_timeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s, &quot;</span>
                        <span class="s2">&quot;assuming end of log.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># Cancellation support</span>
                <span class="k">if</span> <span class="n">cancel_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cancel_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Log download cancelled.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># Use a small timeout so the loop can check the conditions above</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">recv_match</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;LOG_DATA&quot;</span><span class="p">,</span>
                    <span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># No message in this 1-second interval; loop again</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">log_id</span><span class="p">:</span>
                    <span class="c1"># Not our log; ignore</span>
                    <span class="k">continue</span>

                <span class="n">ofs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ofs</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                <span class="n">data_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">count</span><span class="p">])</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">count</span>

                <span class="c1"># Duplicate chunk (same starting offset): ignore</span>
                <span class="k">if</span> <span class="n">ofs</span> <span class="ow">in</span> <span class="n">received_chunks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Duplicate LOG_DATA chunk at ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2">, count=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">, ignoring.&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># We *could* update last_data_time here since link is still active,</span>
                    <span class="c1"># but usually you care about new data only.</span>
                    <span class="k">continue</span>

                <span class="c1"># New chunk</span>
                <span class="n">received_chunks</span><span class="p">[</span><span class="n">ofs</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_bytes</span>
                <span class="n">total_unique_bytes</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">)</span>
                <span class="n">last_data_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">max_end</span><span class="p">:</span>
                    <span class="n">max_end</span> <span class="o">=</span> <span class="n">end</span>

                <span class="c1"># Progress callback (sync)</span>
                <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">callback</span><span class="p">(</span><span class="n">total_unique_bytes</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Callback raised exception: </span><span class="si">{</span><span class="n">e</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># If we know the size, we can stop once we have at least that range</span>
                <span class="k">if</span> <span class="n">size_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_end</span> <span class="o">&gt;=</span> <span class="n">size_bytes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Reached expected size (</span><span class="si">{</span><span class="n">size_bytes</span><span class="si">}</span><span class="s2"> bytes) for log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>

            <span class="c1"># --- Assemble the final buffer ---</span>

            <span class="k">if</span> <span class="n">size_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total_size</span> <span class="o">=</span> <span class="n">size_bytes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total_size</span> <span class="o">=</span> <span class="n">max_end</span>  <span class="c1"># best guess from largest end offset</span>

            <span class="k">if</span> <span class="n">total_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No LOG_DATA received for log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">, returning empty bytes.&quot;</span>
                <span class="p">)</span>
                <span class="n">completed_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

            <span class="n">result</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
            <span class="n">sorted_ofs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">received_chunks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">ofs</span> <span class="ow">in</span> <span class="n">sorted_ofs</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">received_chunks</span><span class="p">[</span><span class="n">ofs</span><span class="p">]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

                <span class="c1"># Detect gaps between chunks</span>
                <span class="k">if</span> <span class="n">ofs</span> <span class="o">&gt;</span> <span class="n">current</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Gap detected in log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;(missing bytes in this range).&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Skip chunks fully beyond the expected size</span>
                <span class="k">if</span> <span class="n">ofs</span> <span class="o">&gt;=</span> <span class="n">total_size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Chunk at ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2"> (len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="si">}</span><span class="s2">) is beyond total_size=</span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2">, skipping.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Trim chunk if it extends past total_size</span>
                <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">]</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">total_size</span>

                <span class="n">result</span><span class="p">[</span><span class="n">ofs</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span>
                <span class="n">current</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Total unique bytes received for log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">total_unique_bytes</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;assembled length=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">completed_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<div class="viewcode-block" id="MavLinkExternalProxy.download_log">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.download_log">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_log</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">completed_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end_of_buffer_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">size_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download one log file via LOG_REQUEST_DATA / LOG_DATA.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log_id :</span>
<span class="sd">            The LOG_ENTRY.id of the log to download.</span>
<span class="sd">        completed_event :</span>
<span class="sd">            threading.Event that will be set when download completes.</span>
<span class="sd">        timeout :</span>
<span class="sd">            Total time allowed for the whole transfer.</span>
<span class="sd">        buffer :</span>
<span class="sd">            Optional bytearray to use as the download buffer.</span>
<span class="sd">        callback :</span>
<span class="sd">            Optional async function called as callback(received_bytes)</span>
<span class="sd">            after each LOG_DATA packet is processed.</span>
<span class="sd">        end_of_buffer_timeout :</span>
<span class="sd">            Timeout in seconds to wait for new data before aborting.</span>
<span class="sd">        size_bytes :</span>
<span class="sd">            Optional total size of the log in bytes., if known.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            Raw log bytes (ULog/Dataflash).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If MAVLink connection is not established.</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            If no complete log is received within the timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>
    
        <span class="n">cancel_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># If you want to support an *async* callback, we wrap it so the sync</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">sync_callback</span><span class="p">(</span><span class="n">received_bytes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Schedule the async callback safely from another thread</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">,</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">received_bytes</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="n">sync_cb</span> <span class="o">=</span> <span class="n">sync_callback</span> <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                <span class="n">log_bytes</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_request_log_sync</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">completed_event</span><span class="o">=</span><span class="n">completed_event</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">size_bytes</span><span class="o">=</span><span class="n">size_bytes</span><span class="p">,</span>
                    <span class="n">cancel_event</span><span class="o">=</span><span class="n">cancel_event</span><span class="p">,</span>
                    <span class="n">callback</span><span class="o">=</span><span class="n">sync_cb</span><span class="p">,</span>
                    <span class="n">end_of_buffer_timeout</span><span class="o">=</span><span class="n">end_of_buffer_timeout</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># process all messages in the buffer</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

        <span class="c1"># sort messages and data by offset</span>
        <span class="n">sorted_msgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">msgs_ofs</span><span class="p">,</span> <span class="n">msgs_data</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msgs_ofs</span><span class="p">,</span> <span class="n">msgs_data</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sorted_msgs</span><span class="p">)</span> <span class="k">if</span> <span class="n">sorted_msgs</span> <span class="k">else</span> <span class="p">([],</span> <span class="p">[])</span>

        <span class="c1"># verify the integrity and reconstruct the log</span>
        <span class="n">last_chunk_details</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ofs&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">bytes_received</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">msgs_ofs</span><span class="p">,</span> <span class="n">msgs_data</span><span class="p">):</span>
            
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># make sure the ofs is as expected (increasing in increments of count)</span>
            <span class="k">if</span> <span class="n">last_chunk_details</span><span class="p">[</span><span class="s2">&quot;ofs&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">expected_ofs</span> <span class="o">=</span> <span class="n">last_chunk_details</span><span class="p">[</span><span class="s2">&quot;ofs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">last_chunk_details</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expected_ofs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">ofs</span> <span class="o">!=</span> <span class="n">expected_ofs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> chunk out of order or missing: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;expected ofs=</span><span class="si">{</span><span class="n">expected_ofs</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;got ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># rerequest the missing chunk(s)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pkt_expected</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_chunk</span><span class="p">(</span>
                            <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                            <span class="n">ofs</span><span class="o">=</span><span class="n">expected_ofs</span><span class="p">,</span>
                            <span class="n">chunk_size</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                            <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
                        <span class="p">)</span>
                        <span class="n">ofs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pkt_expected</span><span class="o">.</span><span class="n">ofs</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pkt_expected</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">pkt_expected</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">count</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> at ofs=</span><span class="si">{</span><span class="n">expected_ofs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> at ofs=</span><span class="si">{</span><span class="n">expected_ofs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span>

                <span class="c1"># Append this chunk into the buffer</span>
                <span class="n">needed_len</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">count</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">needed_len</span><span class="p">:</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">needed_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)))</span>
                <span class="n">buffer</span><span class="p">[</span><span class="n">ofs</span><span class="p">:</span><span class="n">ofs</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">bytes_received</span> <span class="o">+=</span> <span class="n">count</span>

                <span class="c1"># Progress callback (in bytes)</span>
                <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">callback</span><span class="p">(</span><span class="n">bytes_received</span><span class="p">,</span> <span class="s2">&quot;processing&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;download_log callback raised: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">last_chunk_details</span><span class="p">[</span><span class="s2">&quot;ofs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofs</span>
                <span class="n">last_chunk_details</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="n">completed_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.download_log_buffered">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.download_log_buffered">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_log_buffered</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">completed_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="n">size_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">cancel_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytearray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download one log file via repeated LOG_REQUEST_DATA / LOG_DATA exchanges.</span>

<span class="sd">        Strategy:</span>

<span class="sd">        * For ofs = 0, chunk_size, 2*chunk_size, ...</span>

<span class="sd">          * send LOG_REQUEST_DATA(log_id, ofs, chunk_size)</span>
<span class="sd">          * wait for LOG_DATA(log_id, ofs, ...)</span>
<span class="sd">          * append data[:count]</span>
<span class="sd">          * stop when:</span>

<span class="sd">            * count == 0 (end-of-log by spec), or</span>
<span class="sd">            * ofs + count &gt;= size_bytes (if known)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log_id :</span>
<span class="sd">            LOG_ENTRY.id of the log to download.</span>
<span class="sd">        completed_event :</span>
<span class="sd">            threading.Event set when download is fully complete.</span>
<span class="sd">        size_bytes :</span>
<span class="sd">            Optional total size of the log from LOG_ENTRY.size; if given, used as</span>
<span class="sd">            termination condition and sanity cap.</span>
<span class="sd">        timeout :</span>
<span class="sd">            Timeout per chunk request (seconds).</span>
<span class="sd">        chunk_size :</span>
<span class="sd">            Requested count per chunk. For MAVLink v1, LOG_DATA carries 90 bytes.</span>
<span class="sd">        max_retries :</span>
<span class="sd">            Number of retries per chunk on timeout.</span>
<span class="sd">        cancel_event :</span>
<span class="sd">            Optional threading.Event to cancel the download.</span>
<span class="sd">        buffer :</span>
<span class="sd">            Optional bytearray; if None, a new one is created.</span>
<span class="sd">        callback :</span>
<span class="sd">            Optional sync or async callback called as callback(total_bytes_received)</span>
<span class="sd">            after each successful chunk.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            Raw log data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>

        <span class="n">LOG_DATA_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_LOG_DATA</span><span class="p">)</span>

        <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cancel_event</span> <span class="ow">and</span> <span class="n">cancel_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="c1"># Let caller decide what to do; could also raise here</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download of log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> cancelled at ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># If we know the size and we&#39;ve already covered it, stop</span>
            <span class="k">if</span> <span class="n">size_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ofs</span> <span class="o">&gt;=</span> <span class="n">size_bytes</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pkt</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_chunk</span><span class="p">(</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">ofs</span><span class="o">=</span><span class="n">ofs</span><span class="p">,</span>
                    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                    <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> at ofs=</span><span class="si">{</span><span class="n">ofs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Termination condition from spec: count == 0 =&gt; end-of-log</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Append this chunk into the buffer</span>
            <span class="n">needed_len</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">+</span> <span class="n">count</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">needed_len</span><span class="p">:</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">needed_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)))</span>
            <span class="n">buffer</span><span class="p">[</span><span class="n">ofs</span><span class="p">:</span><span class="n">ofs</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">count</span><span class="p">])</span>

            <span class="c1"># Progress callback (in bytes)</span>
            <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">callback</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;download_log callback raised: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ofs</span> <span class="o">+=</span> <span class="n">count</span>

            <span class="c1"># If we know the total size and we&#39;ve just covered it, stop</span>
            <span class="k">if</span> <span class="n">size_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ofs</span> <span class="o">&gt;=</span> <span class="n">size_bytes</span><span class="p">:</span>
                <span class="n">completed_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">break</span>

            <span class="c1"># If size_bytes is unknown and we received less than chunk_size,</span>
            <span class="c1"># it&#39;s probably the last chunk, so we can stop.</span>
            <span class="k">if</span> <span class="n">size_bytes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">chunk_size</span><span class="p">:</span>
                <span class="n">completed_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.set_params_bulk_lossy">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.set_params_bulk_lossy">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_params_bulk_lossy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_to_set</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ParamSpec</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout_total</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">8.0</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">resend_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">inter_send_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">verify_ack_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lossy-link bulk PARAM_SET:</span>
<span class="sd">        - User can provide optional type per param as &quot;UINT8&quot;, &quot;INT16&quot;, &quot;REAL32&quot;, etc.</span>
<span class="sd">        - If type omitted -&gt; auto: int -&gt; INT32, float -&gt; REAL32</span>
<span class="sd">        - Windowed sends + periodic resend + retry cap</span>
<span class="sd">        - Confirms via echoed PARAM_VALUE</span>

<span class="sd">        Returns: confirmed {name: meta_dict}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>

        <span class="c1"># Normalize input into: desired[name] = (value, ptype_int_or_None)</span>
        <span class="n">desired</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">params_to_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm_name</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">ptype</span> <span class="o">=</span> <span class="n">spec</span>
                <span class="n">desired</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_parse_param_type</span><span class="p">(</span><span class="n">ptype</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Param &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; dict spec must include &#39;value&#39;&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">desired</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_parse_param_type</span><span class="p">(</span><span class="n">ptype</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">desired</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">infer_type</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_INT32</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAV_PARAM_TYPE_REAL32</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported value type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> (expected int or float)&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">values_match</span><span class="p">(</span><span class="n">want</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">got</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">got</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">want</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">got</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">want</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mf">1e-4</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">pending</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">desired</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">attempts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">}</span>
        <span class="n">last_sent</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">}</span>
        <span class="n">confirmed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">desired</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">in_flight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">done_evt</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_set</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">in_flight</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">ptype_opt</span> <span class="o">=</span> <span class="n">desired</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">ptype_opt</span> <span class="k">if</span> <span class="n">ptype_opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">infer_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_param_set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">ptype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="n">attempts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">last_sent</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="n">in_flight</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">inter_send_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">inter_send_delay</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fill_window_from_queue</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">in_flight</span>
            <span class="k">while</span> <span class="n">in_flight</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pending</span> <span class="ow">and</span> <span class="n">attempts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">_send_set</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_resender_loop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">in_flight</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done_evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

                <span class="c1"># initial sends</span>
                <span class="k">await</span> <span class="n">_fill_window_from_queue</span><span class="p">()</span>

                <span class="c1"># resend timed-out pendings</span>
                <span class="k">if</span> <span class="n">in_flight</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pending</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">attempts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_sent</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">resend_interval</span> <span class="ow">and</span> <span class="n">in_flight</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">_send_set</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">pname</span><span class="p">,</span> <span class="n">decoded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_param_value</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_apply</span><span class="p">():</span>
                    <span class="k">nonlocal</span> <span class="n">in_flight</span>
                    <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                        <span class="k">return</span>

                    <span class="n">want_value</span><span class="p">,</span> <span class="n">_want_ptype</span> <span class="o">=</span> <span class="n">desired</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">verify_ack_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">values_match</span><span class="p">(</span><span class="n">want_value</span><span class="p">,</span> <span class="n">decoded_value</span><span class="p">):</span>
                        <span class="c1"># not confirmed; free one slot and let retry logic resend</span>
                        <span class="n">in_flight</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_flight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="n">confirmed</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">pname</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">decoded_value</span><span class="p">,</span>
                        <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">param_value</span><span class="p">),</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_type</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_count</span><span class="p">,</span>
                        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_index</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="n">pending</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">in_flight</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_flight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
                        <span class="n">done_evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">_apply</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bulk_set handler] raised: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_handler</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start sending + resending</span>
            <span class="k">await</span> <span class="n">_fill_window_from_queue</span><span class="p">()</span>
            <span class="n">resender_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_resender_loop</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">done_evt</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_total</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">resender_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">resender_task</span>

            <span class="k">return</span> <span class="n">confirmed</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregister_handler</span><span class="p">(</span><span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">,</span> <span class="n">_handler</span><span class="p">)</span></div>


<div class="viewcode-block" id="MavLinkExternalProxy.get_params_bulk_lossy">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkExternalProxy.get_params_bulk_lossy">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_params_bulk_lossy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout_total</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6.0</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">resend_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="n">inter_send_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lossy-link bulk GET using PARAM_REQUEST_READ by name.</span>

<span class="sd">        Strategy:</span>
<span class="sd">        - Register ONE PARAM_VALUE handler.</span>
<span class="sd">        - Send read requests in a window (max_in_flight).</span>
<span class="sd">        - Periodically resend still-pending names (resend_interval) up to max_retries.</span>
<span class="sd">        - Stop when all received or timeout_total.</span>

<span class="sd">        Returns:</span>
<span class="sd">        { name: {&quot;name&quot;,&quot;value&quot;,&quot;raw&quot;,&quot;type&quot;,&quot;count&quot;,&quot;index&quot;}, ... }</span>
<span class="sd">        (Partial results if timeout_total hits.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established&quot;</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>

        <span class="c1"># Normalize requested names (same normalization used by _decode_param_value)</span>
        <span class="n">names_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_norm_name</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

        <span class="n">pending</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names_list</span><span class="p">)</span>
        <span class="n">attempts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names_list</span><span class="p">}</span>
        <span class="n">last_sent</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names_list</span><span class="p">}</span>

        <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">done_evt</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">names_list</span><span class="p">)</span>
        <span class="n">in_flight</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_read</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">in_flight</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_param_request_read</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;mav&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="n">attempts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">last_sent</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="n">in_flight</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">inter_send_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">inter_send_delay</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fill_window_from_queue</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">in_flight</span>
            <span class="k">while</span> <span class="n">in_flight</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="n">queue</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">pending</span> <span class="ow">and</span> <span class="n">attempts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">_send_read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_resender_loop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">in_flight</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done_evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

                <span class="c1"># initial sends</span>
                <span class="k">await</span> <span class="n">_fill_window_from_queue</span><span class="p">()</span>

                <span class="c1"># resend timed-out pending items</span>
                <span class="k">if</span> <span class="n">in_flight</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pending</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">attempts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_sent</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">resend_interval</span> <span class="ow">and</span> <span class="n">in_flight</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">_send_read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handler</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="n">pname</span><span class="p">,</span> <span class="n">decoded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_param_value</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">_apply</span><span class="p">():</span>
                    <span class="k">nonlocal</span> <span class="n">in_flight</span>
                    <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                        <span class="k">return</span>

                    <span class="n">results</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">pname</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">decoded_value</span><span class="p">,</span>
                        <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">pkt</span><span class="o">.</span><span class="n">param_value</span><span class="p">),</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_type</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_count</span><span class="p">,</span>
                        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">param_index</span><span class="p">,</span>
                    <span class="p">}</span>

                    <span class="n">pending</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="c1"># Free one in-flight slot (treat this response as completing one request)</span>
                    <span class="n">in_flight</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_flight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pending</span><span class="p">:</span>
                        <span class="n">done_evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">_apply</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bulk_get handler] raised: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_handler</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start sending + resending</span>
            <span class="k">await</span> <span class="n">_fill_window_from_queue</span><span class="p">()</span>
            <span class="n">resender_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_resender_loop</span><span class="p">())</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">done_evt</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_total</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="c1"># return partial results</span>
                <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">resender_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">resender_task</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregister_handler</span><span class="p">(</span><span class="s2">&quot;PARAM_VALUE&quot;</span><span class="p">,</span> <span class="n">_handler</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="MavLinkFTPProxy">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MavLinkFTPProxy</span><span class="p">(</span><span class="n">BaseProxy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Threaded MAVLink FTP driver using `pymavlink`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mavlink_proxy</span><span class="p">:</span> <span class="n">MavLinkExternalProxy</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;MavLinkFTPProxy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thread_name_prefix</span><span class="o">=</span><span class="s2">&quot;MavLinkFTPProxyWorker&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="p">:</span> <span class="n">MavLinkExternalProxy</span> <span class="o">=</span> <span class="n">mavlink_proxy</span>

    <span class="c1"># ------------------------ life-cycle --------------------- #</span>
<div class="viewcode-block" id="MavLinkFTPProxy.start">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the MAVLink connection then launch the worker thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        
        <span class="c1"># Start the worker thread first</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


        <span class="c1"># # Initialize parser if connection was successful</span>
        <span class="c1"># if self.mavlink_proxy.master:</span>
        <span class="c1">#     await self._init_parser()</span>

<div class="viewcode-block" id="MavLinkFTPProxy.stop">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.stop">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the worker and close the link.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Ensure any pending writes are flushed</span></div>

        
    <span class="c1"># ------------------- I/O primitives --------------------- #</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_init_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the blocking parser.&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">create_parser</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_BlockingParser</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> 
            <span class="n">create_parser</span>
        <span class="p">)</span>

    <span class="c1"># ------------------- deletion helper with fallback ------------- #</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_delete_file_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a file on the vehicle, trying shell rm first then MAVFTP.</span>

<span class="sd">        On real NuttX hardware the shell ``rm`` command works and bypasses</span>
<span class="sd">        PX4&#39;s MAVFTP ``FileProtected`` restriction.  In SITL builds the</span>
<span class="sd">        NuttX shell is not available (``Invalid command: rm``), so we</span>
<span class="sd">        fall back to MAVFTP ``cmd_rm`` which works there.</span>

<span class="sd">        The caller is responsible for stopping the PX4 logger before</span>
<span class="sd">        invoking this method.</span>

<span class="sd">        Returns ``True`` on success, ``False`` on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Try the NuttX shell rm (works on real hardware)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">delete_file_via_shell</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># 2) Fall back to MAVFTP cmd_rm (works on SITL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shell rm failed for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">, falling back to MAVFTP delete&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_ftp_delete</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAVFTP delete also failed for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="n">_ftp_delete</span><span class="p">)</span>

    <span class="c1"># ------------------- exposing blocking parser methods --------- #</span>
<div class="viewcode-block" id="MavLinkFTPProxy.list_ulogs">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.list_ulogs">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_ulogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ULogInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return metadata for every .ulg file on the vehicle.&quot;&quot;&quot;</span>
        <span class="c1"># Check connection and attempt to establish if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FTP connection not established, attempting to connect...&quot;</span><span class="p">)</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># brief wait before re-checking</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink FTP connection&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink FTP connection could not be established&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">root_sd_path</span>

        <span class="c1"># Initialize parser if not already done (e.g., after reconnection)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

        <span class="c1"># Try to get log entries from the vehicle, but handle timeout gracefully</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mavutil</span><span class="o">.</span><span class="n">mavlink</span><span class="o">.</span><span class="n">MAVLINK_MSG_ID_LOG_ENTRY</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">build_req_msg_log_request</span><span class="p">(</span><span class="n">message_id</span><span class="o">=</span><span class="n">msg_id</span><span class="p">)</span>

            <span class="n">entries</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">get_log_entries</span><span class="p">(</span>
                <span class="n">msg_id</span><span class="o">=</span><span class="n">msg_id</span><span class="p">,</span>
                <span class="n">request_msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get log entries from vehicle: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to list files directly via FTP without log entries...&quot;</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Attempt to list files via FTP</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">list_ulogs</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">ULogInfo</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list files via FTP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="MavLinkFTPProxy.download_ulog">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.download_ulog">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_ulog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">local_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">completed_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="n">on_progress</span><span class="p">:</span> <span class="n">ProgressCB</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">n_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch *remote_path* from the vehicle into *local_path*.</span>

<span class="sd">        Returns the Path actually written on success or None if cancelled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check connection and attempt to establish if needed</span>

        <span class="n">last_exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_attempts</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FTP connection not established, attempting to connect...&quot;</span><span class="p">)</span>
                <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># brief wait before re-checking</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink FTP connection&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink FTP connection could not be established&quot;</span><span class="p">)</span>

            <span class="c1"># Initialize parser if not already done (e.g., after reconnection)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">download_ulog</span><span class="p">,</span> 
                    <span class="n">remote_path</span><span class="p">,</span> 
                    <span class="n">local_path</span><span class="p">,</span> 
                    <span class="n">on_progress</span><span class="p">,</span>
                    <span class="n">cancel_event</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">completed_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">local_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Download was cancelled or failed without exception&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download ulog via FTP on attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_attempts</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>
                
        <span class="k">if</span> <span class="n">last_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="n">n_attempts</span><span class="si">}</span><span class="s2"> attempts to download ulog failed.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">last_exception</span></div>

    
<div class="viewcode-block" id="MavLinkFTPProxy.delete_file">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.delete_file">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">stop_logger</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a single file at *remote_path* on the vehicle.</span>

<span class="sd">        Uses the NuttX shell ``rm`` command via MAVLink SERIAL_CONTROL,</span>
<span class="sd">        which bypasses PX4&#39;s MAVFTP ``FileProtected`` restriction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote_path : str</span>
<span class="sd">            The path on the vehicle to delete.</span>
<span class="sd">        connection_timeout : float</span>
<span class="sd">            Maximum time to wait for MAVLink connection.</span>
<span class="sd">        stop_logger : bool</span>
<span class="sd">            If True, stop PX4 logging before deletion and restart it</span>
<span class="sd">            afterwards.  Pass ``False`` when the caller has already</span>
<span class="sd">            stopped the logger (e.g. bulk-delete loop).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established, attempting to connect...&quot;</span><span class="p">)</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink connection&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection could not be established&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stop_logger</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">stop_px4_logging</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_file_with_fallback</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete failed for </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2"> (shell rm and MAVFTP both failed)&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stop_logger</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">start_px4_logging</span><span class="p">()</span></div>


<div class="viewcode-block" id="MavLinkFTPProxy.delete_all_logs">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.delete_all_logs">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_all_logs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">progress_callback</span><span class="p">:</span> <span class="s2">&quot;Callable[[int, int], Any] | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively delete every ``.ulg`` file under *base* on the vehicle.</span>

<span class="sd">        Uses MAVFTP only for *listing* directories, then deletes each file</span>
<span class="sd">        via the NuttX shell ``rm`` command (MAVLink SERIAL_CONTROL).  This</span>
<span class="sd">        bypasses PX4&#39;s MAVFTP ``FileProtected`` (code 9) restriction which</span>
<span class="sd">        blocks ``cmd_rm`` on all log files.</span>

<span class="sd">        Stops the PX4 logger before deletion and restarts it afterwards.</span>

<span class="sd">        Args:</span>
<span class="sd">            base: Root directory to scan for .ulg files.</span>
<span class="sd">            connection_timeout: Seconds to wait for a MAVLink connection.</span>
<span class="sd">            progress_callback: Optional ``callback(current_index, total)``</span>
<span class="sd">                invoked after each file deletion attempt.  May be a</span>
<span class="sd">                regular function or an ``async`` coroutine.</span>

<span class="sd">        Returns a summary dict with deleted/failed counts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not established, attempting to connect...&quot;</span><span class="p">)</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink connection&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection could not be established&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">root_sd_path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

        <span class="c1"># ── Discover .ulg files AND date directories in one pass ──</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_scan</span><span class="p">(</span><span class="n">base_dir</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return (file_list, date_dir_list).&quot;&quot;&quot;</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># Empty directory → MAVFTP returns code 73 (timeout).</span>
                <span class="c1"># Treat as &quot;nothing to delete&quot;.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Base directory listing failed (</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">) — &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;assuming empty, nothing to delete&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">dirs</span>
            <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">is_dir</span> <span class="ow">in</span> <span class="n">base_entries</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dir</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">child_is_dir</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">child_is_dir</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ulg&quot;</span><span class="p">):</span>
                        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">dirs</span>

        <span class="n">ulog_files</span><span class="p">,</span> <span class="n">date_dirs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_scan</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ulog_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> ULog file(s) under </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> — &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;deleting via shell rm&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Stop PX4 logger before deletion to release file handles</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">stop_px4_logging</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ulog_files</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ulog_files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_file_with_fallback</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">remote_path</span><span class="p">,</span>
                        <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
                    <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">remote_path</span><span class="p">,</span>
                        <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Delete failed (shell rm and MAVFTP)&quot;</span><span class="p">,</span>
                    <span class="p">})</span>
                    <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Report per-file progress</span>
                <span class="k">if</span> <span class="n">progress_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="n">progress_callback</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutine</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
                            <span class="k">await</span> <span class="n">ret</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>  <span class="c1"># never let a callback error abort deletion</span>

            <span class="c1"># ── Clean up ALL discovered date directories ─────────</span>
            <span class="c1"># Remove every date dir we found during listing, not</span>
            <span class="c1"># just those that had deleted files.  This ensures dirs</span>
            <span class="c1"># left empty by a previous run are also removed.</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">date_dirs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">delete_file_via_shell</span><span class="p">(</span>
                        <span class="n">d</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s2">&quot;rmdir&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed empty directory </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rmdir </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2"> skipped (may not be empty)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rmdir </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">deleted</span> <span class="o">+</span> <span class="n">failed</span><span class="p">,</span>
                <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">deleted</span><span class="p">,</span>
                <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">,</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Delete all logs complete: </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> deleted, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s2"> failed out of </span><span class="si">{</span><span class="n">deleted</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failed</span><span class="si">}</span><span class="s2"> total&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">summary</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always restart the logger, even if deletion failed</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">start_px4_logging</span><span class="p">()</span></div>


<div class="viewcode-block" id="MavLinkFTPProxy.detect_error_logs">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.detect_error_logs">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">detect_error_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect ``fail_*.log`` error log files under *remote_path* on the vehicle.</span>

<span class="sd">        Lists files via MAVFTP without deleting anything.</span>

<span class="sd">        Returns a summary dict ``{total, files}`` where *files* is a list of</span>
<span class="sd">        ``{path, size_bytes}`` dicts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check connection and attempt to establish if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FTP connection not established, attempting to connect...&quot;</span><span class="p">)</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink FTP connection&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink FTP connection could not be established&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize parser if not already done</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

        <span class="c1"># List fail_*.log files via MAVFTP</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_list_fail_logs</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span>
                    <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">is_dir</span> <span class="ow">in</span> <span class="n">entries</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dir</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fail_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list error logs in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

        <span class="n">fail_logs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="n">_list_fail_logs</span><span class="p">)</span>

        <span class="n">files_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">fail_logs</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_info</span><span class="p">)</span><span class="si">}</span><span class="s2"> fail_*.log file(s) under </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_info</span><span class="p">),</span> <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">files_info</span><span class="p">}</span></div>


<div class="viewcode-block" id="MavLinkFTPProxy.clear_error_logs">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.clear_error_logs">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clear_error_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear ``fail_*.log`` error logs under *remote_path* from the vehicle.</span>

<span class="sd">        Uses MAVFTP only for *listing*, then deletes each file via the</span>
<span class="sd">        NuttX shell ``rm`` command (same approach as ``delete_all_logs``).</span>

<span class="sd">        Returns a summary dict ``{total, deleted, failed}``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check connection and attempt to establish if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FTP connection not established, attempting to connect...&quot;</span><span class="p">)</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink FTP connection&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink FTP connection could not be established&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize parser if not already done</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

        <span class="c1"># List fail_*.log files via MAVFTP</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_list_fail_logs</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span>
                    <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">is_dir</span> <span class="ow">in</span> <span class="n">entries</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dir</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fail_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list error logs in </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

        <span class="n">fail_logs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="n">_list_fail_logs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fail_logs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No fail_*.log files found under </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fail_logs</span><span class="p">)</span><span class="si">}</span><span class="s2"> fail_*.log file(s) under </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Stop logger, delete via shell rm (with MAVFTP fallback), restart logger</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">stop_px4_logging</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">_size</span> <span class="ow">in</span> <span class="n">fail_logs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_file_with_fallback</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted error log </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete failed for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> (shell rm and MAVFTP)&quot;</span><span class="p">)</span>
                        <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">start_px4_logging</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Clear error logs complete: </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> deleted, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s2"> failed out of </span><span class="si">{</span><span class="n">deleted</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failed</span><span class="si">}</span><span class="s2"> total&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">deleted</span> <span class="o">+</span> <span class="n">failed</span><span class="p">,</span> <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">deleted</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">}</span></div>


<div class="viewcode-block" id="MavLinkFTPProxy.list_directory">
<a class="viewcode-back" href="../../../api_reference/proxies.html#petal_app_manager.proxies.external.MavLinkFTPProxy.list_directory">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all files and directories under *base* on the vehicle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check connection and attempt to establish if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FTP connection not established, attempting to connect...&quot;</span><span class="p">)</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># brief wait before re-checking</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="n">connection_timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for MAVLink FTP connection&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink FTP connection could not be established&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mavlink_proxy</span><span class="o">.</span><span class="n">root_sd_path</span>

        <span class="c1"># Initialize parser if not already done (e.g., after reconnection)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parser&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_parser</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">listing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">list_directory</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">listing</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list directory via FTP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>
</div>


<span class="c1"># --------------------------------------------------------------------------- #</span>
<span class="c1">#  helper functions                                                           #</span>
<span class="c1"># --------------------------------------------------------------------------- #</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_match_ls_to_entries</span><span class="p">(</span>
    <span class="n">ls_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">entry_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">threshold_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="n">files</span>  <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ls_list</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entry_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ls and entry counts differ; can&#39;t match safely&quot;</span><span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">log_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sz</span> <span class="o">-</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">threshold_size</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">log_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">])</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">mapping</span>

<span class="k">class</span><span class="w"> </span><span class="nc">_BlockingParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thin wrapper around pymavlink / MAVFTP - runs in a dedicated thread.</span>
<span class="sd">    All methods are synchronous and blocking; the proxy wraps them in</span>
<span class="sd">    run_in_executor so the event-loop stays responsive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------- life-cycle -------------------------------------------------- #</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
            <span class="n">master</span><span class="p">:</span> <span class="n">mavutil</span><span class="o">.</span><span class="n">mavserial</span><span class="p">,</span>
            <span class="n">mavlink_proxy</span><span class="p">:</span> <span class="n">MavLinkExternalProxy</span><span class="p">,</span>
            <span class="n">debug</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;BlockingParser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">mavlink_proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_sd_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">root_sd_path</span>
        <span class="c1"># try three times to init MAVFTP</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink master not initialized MAVFTP proxy failed&quot;</span><span class="p">)</span>
                    
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="n">mavftp</span><span class="o">.</span><span class="n">MAVFTP</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_component</span>
                        <span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAVFTP init attempt failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVFTP init failed after 3 attempts&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MAVFTP initialized successfully&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">ftp_settings</span><span class="o">.</span><span class="n">debug</span>            <span class="o">=</span> <span class="n">debug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">ftp_settings</span><span class="o">.</span><span class="n">retry_time</span>       <span class="o">=</span> <span class="mf">0.2</span>   <span class="c1"># 200 ms instead of 1 s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">ftp_settings</span><span class="o">.</span><span class="n">burst_read_size</span>  <span class="o">=</span> <span class="mi">239</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">burst_size</span>                    <span class="o">=</span> <span class="mi">239</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize MAVFTP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">system_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="c1"># convenience for log message in proxy.start()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">target_system</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># ---------- public helpers (blocking) ----------------------------------- #</span>

    <span class="c1"># 1) list_ulogs ---------------------------------------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_ulogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">base</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ULogInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enumerate *.ulg under the SD-card and return a list of dicts</span>
<span class="sd">        that can be fed directly into ULogInfo(**dict).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ulog_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_walk_ulogs</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ulog_files</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># If we have log entries from the vehicle, try to match them with files</span>
        <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="n">_match_ls_to_entries</span><span class="p">(</span><span class="n">ulog_files</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span>
                <span class="c1"># sort the mapping by utc descending</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">mapping</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># sort by utc (index 2)</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">utc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mapping</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">remote_path</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">size_bytes</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to match files with log entries: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Fall through to basic file listing</span>
        
        <span class="c1"># If no entries or matching failed, return basic file info without UTC timestamps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Returning basic file listing without log entry metadata&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ulog_files</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">remote_path</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">size_bytes</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># UTC=0 when unknown</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># 2) download_ulog ------------------------------------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_ulog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">local_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">on_progress</span><span class="p">:</span> <span class="n">ProgressCB</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cancel_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Blocking download with retry + tmp-file recovery with cancellation support.&quot;&quot;&quot;</span>

        <span class="c1"># ------------------------------------------------------------------ #</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_progress_cb</span><span class="p">(</span><span class="n">frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">frac</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">on_progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># Check for cancellation</span>
            <span class="k">if</span> <span class="n">cancel_event</span> <span class="ow">and</span> <span class="n">cancel_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="c1"># Use our custom exception to signal cancellation</span>
                <span class="k">raise</span> <span class="n">DownloadCancelledException</span><span class="p">(</span><span class="s2">&quot;Download cancelled by user&quot;</span><span class="p">)</span>
                
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
                <span class="n">on_progress</span><span class="p">(</span><span class="n">frac</span><span class="p">),</span>
                <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_loop</span>
            <span class="p">)</span>
        <span class="c1"># ------------------------------------------------------------------ #</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading </span><span class="si">%s</span><span class="s2"> → </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
            <span class="n">local_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>

                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cmd_get</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">remote_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">())],</span>
                        <span class="n">progress_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_progress_cb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenFileRO failed: download failed with code </span><span class="si">{</span><span class="n">ret</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">None</span>

                    <span class="c1"># Check for cancellation before processing reply</span>
                    <span class="k">if</span> <span class="n">cancel_event</span> <span class="ow">and</span> <span class="n">cancel_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">None</span>

                    <span class="c1"># Process the reply with a try-except to handle potential issues</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">process_ftp_reply</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">operation_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    
                        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenFileRO Download failed with code </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                            <span class="k">return</span> <span class="kc">None</span>
                    
                    <span class="k">except</span> <span class="n">DownloadCancelledException</span><span class="p">:</span>
                        <span class="c1"># Handle cancellation gracefully</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Download cancelled by user&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FTP error during download: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing FTP reply: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="c1"># handle temp-file move failure</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">temp_filename</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Temp file recovered to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span> <span class="c1"># for next download</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to recover temp file to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%.1f</span><span class="s2"> KiB)&quot;</span><span class="p">,</span>
                                <span class="n">local_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">local_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">DownloadCancelledException</span><span class="p">:</span>
            <span class="c1"># Handle cancellation gracefully at the outer level too</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Download cancelled by user&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">raise</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle connection errors (including &quot;Bad file descriptor&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>

            <span class="c1"># Clean up partial file</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="c1"># Re-raise the original exception</span>
            <span class="k">raise</span>
            
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Always reset FTP state on error</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>

            <span class="c1"># Clean up partial file</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                
            <span class="c1"># Re-raise the original exception</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Always reset FTP state on error</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>

            <span class="c1"># Clean up partial file</span>
            <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">local_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                
            <span class="c1"># Re-raise the original exception</span>
            <span class="k">raise</span>

    <span class="c1"># 3) clear error logs ---------------------------------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_error_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fs/microsd&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fail_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_fail_logs</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">fail_logs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting error log </span><span class="si">{</span><span class="n">log</span><span class="o">.</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Check if connection is still valid before attempting operation</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost, skipping delete for </span><span class="si">{</span><span class="n">log</span><span class="o">.</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Give some time for the delete operation to complete</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle connection errors gracefully</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPIPE</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost during delete operation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error deleting log </span><span class="si">{</span><span class="n">log</span><span class="o">.</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting log </span><span class="si">{</span><span class="n">log</span><span class="o">.</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared all error logs&quot;</span><span class="p">)</span>

    <span class="c1"># 4) delete_file --------------------------------------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a single file at *path* on the vehicle via MAVFTP.</span>
<span class="sd">        Wraps the private ``_delete`` helper with a public interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting file: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not available for delete operation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># 5) delete_all_logs ----------------------------------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_all_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fs/microsd/log&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively walk *base* (same logic as ``_walk_ulogs``) and delete</span>
<span class="sd">        every ``.ulg`` file found.  Does NOT require log entries from the</span>
<span class="sd">        vehicle – purely filesystem-based.</span>

<span class="sd">        .. note::</span>

<span class="sd">           The caller (``MavLinkFTPProxy.delete_all_logs``) is responsible</span>
<span class="sd">           for stopping PX4 logging **before** invoking this method.</span>
<span class="sd">           Without that, PX4 returns ``FileProtected`` (FTP code 9) for</span>
<span class="sd">           every file because the logger holds open file handles.</span>

<span class="sd">        Returns a summary dict with ``deleted``, ``failed``, and ``total``</span>
<span class="sd">        counts plus a list of per-file results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting all ULog files under </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;MAVLink connection not available for delete operation&quot;</span><span class="p">)</span>

        <span class="c1"># Reset FTP state before starting the delete loop to ensure a clean session</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>

        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_walk_ulogs</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">remote_path</span><span class="p">,</span> <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">})</span>
                <span class="n">deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># brief pause between deletes</span>
            <span class="k">except</span> <span class="n">FTPDeleteError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">remote_path</span><span class="p">,</span>
                    <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;ftp_code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">ftp_code</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">remote_path</span><span class="p">,</span> <span class="s2">&quot;size_bytes&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">deleted</span> <span class="o">+</span> <span class="n">failed</span><span class="p">,</span>
            <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">deleted</span><span class="p">,</span>
            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">,</span>
            <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete all logs complete: </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> deleted, </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s2"> failed out of </span><span class="si">{</span><span class="n">deleted</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">failed</span><span class="si">}</span><span class="s2"> total&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="c1"># 6) ls a directory ------------------------------------------------------ #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fs/microsd&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List the contents of a directory on the vehicle&#39;s filesystem.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listing directory: </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Check if connection is still valid before attempting operation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost, skipping ls for </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error listing directory </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># ---------- internal helpers ------------------------------------------- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_ftp_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all FTP state to handle canceled transfers properly.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Resetting FTP state&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First try to terminate the current session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">_MAVFTP__terminate_session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">process_ftp_reply</span><span class="p">(</span><span class="s2">&quot;TerminateSession&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error terminating session: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Then reset all sessions for good measure</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">mavftp</span><span class="o">.</span><span class="n">OP_ResetSessions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">_MAVFTP__send</span><span class="p">(</span><span class="n">FTP_OP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">process_ftp_reply</span><span class="p">(</span><span class="s2">&quot;ResetSessions&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resetting sessions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="c1"># Reset internal dictionaries that could cause issues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">active_read_sessions</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># These are the problematic data structures that cause the KeyError</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;read_gap_times&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">read_gap_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;read_gaps&#39;</span><span class="p">):</span>
            <span class="c1"># This should be a list, not a dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">read_gaps</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="c1"># Reset session counter and tracking</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;next_read_session&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">next_read_session</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;seq&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="c1"># Reset other stateful variables</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;read_total&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">read_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;read_offset&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">read_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;remote_file_size&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">remote_file_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">,</span> <span class="s1">&#39;burst_state&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">burst_state</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_walk_ulogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;fs/microsd/log&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">is_dir</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dir</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">: listing failed (</span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">is_dir</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dir</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ulg&quot;</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span>

    <span class="c1"># plain MAVFTP ls</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if connection and master are valid before attempting operation</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection not available, skipping ls for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Return empty list if all retries exhausted</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Additional check: verify the file descriptor is still valid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Test if the socket is still open by checking its fileno</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="s1">&#39;fileno&#39;</span><span class="p">):</span>
                        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Invalid file descriptor&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File descriptor invalid, marking connection as lost (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[]</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                        <span class="c1"># Double-check connection inside the lock</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost during lock acquisition for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                                <span class="k">return</span> <span class="p">[]</span>
                            <span class="k">continue</span>
                            
                        <span class="n">ack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cmd_list</span><span class="p">([</span><span class="n">path</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ack</span><span class="o">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">size_b</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">is_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">list_result</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># FTP command failed - check if it&#39;s a retryable error</span>
                            <span class="k">if</span> <span class="n">ack</span><span class="o">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># Error code 1 typically means &quot;file/directory not found&quot; or &quot;permission denied&quot;</span>
                                <span class="c1"># This is not a connection issue, so don&#39;t retry</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FTP ls failed: path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; not found or not accessible (return code </span><span class="si">{</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># Return empty list instead of raising error</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Other error codes might be retryable</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FTP ls command failed with return code </span><span class="si">{</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2"> (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ls(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed after </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts: FTP return code </span><span class="si">{</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle connection errors gracefully</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPIPE</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost during ls operation&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ls(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed after </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts due to connection loss&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected socket error during ls: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during ls operation (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ls(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed after </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># If we reach here, the operation failed but we can retry</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying ls operation for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s (attempt </span><span class="si">{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ls(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">×&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_list_fail_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fs/microsd&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ULogInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all fail_*.log files under the given *base* directory. without walking</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ls</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">fail_logs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ULogInfo</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">remote_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size_bytes</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">is_dir</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dir</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fail_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">fail_logs</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list fail logs in </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a file or directory at *path* using MAVFTP.</span>
<span class="sd">        Retries on failure up to *retries* times with *delay* seconds between attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if connection and master are valid before attempting operation</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection not available, skipping delete for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">return</span>  <span class="c1"># Give up after all retries</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Additional check: verify the file descriptor is still valid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="s1">&#39;fileno&#39;</span><span class="p">):</span>
                        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Invalid file descriptor&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File descriptor invalid for delete, marking connection as lost (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_ftp_state</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_mav_lock</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">_download_lock</span><span class="p">:</span>
                        <span class="c1"># Double-check connection inside the lock</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost during lock acquisition for delete </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                                <span class="k">return</span>
                            <span class="k">continue</span>
                            
                        <span class="n">ack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cmd_rm</span><span class="p">([</span><span class="n">path</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ack</span><span class="o">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully deleted </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">return</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Translate FTP error codes to human-readable messages</span>
                            <span class="n">_FTP_ERR_NAMES</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Fail&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;FailErrno&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;InvalidDataSize&quot;</span><span class="p">,</span>
                                <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;InvalidSession&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;NoSessionsAvailable&quot;</span><span class="p">,</span>
                                <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;EndOfFile&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;UnknownCommand&quot;</span><span class="p">,</span>
                                <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;FileExists&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s2">&quot;FileProtected&quot;</span><span class="p">,</span>
                                <span class="mi">10</span><span class="p">:</span> <span class="s2">&quot;FileNotFound&quot;</span><span class="p">,</span> <span class="mi">73</span><span class="p">:</span> <span class="s2">&quot;RemoteReplyTimeout&quot;</span><span class="p">,</span>
                            <span class="p">}</span>
                            <span class="n">err_name</span> <span class="o">=</span> <span class="n">_FTP_ERR_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown(</span><span class="si">{</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                            <span class="n">detail</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;FTP delete failed: </span><span class="si">{</span><span class="n">err_name</span><span class="si">}</span><span class="s2"> (code </span><span class="si">{</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">) &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">ack</span><span class="o">.</span><span class="n">return_code</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>  <span class="c1"># FileProtected</span>
                                <span class="n">detail</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="s2">&quot; — PX4 logger likely has the file locked. &quot;</span>
                                    <span class="s2">&quot;Ensure &#39;logger stop&#39; is sent before deleting.&quot;</span>
                                <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">FTPDeleteError</span><span class="p">(</span>
                                    <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                    <span class="n">ftp_code</span><span class="o">=</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="p">,</span>
                                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;delete(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed after </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts: &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err_name</span><span class="si">}</span><span class="s2"> (FTP code </span><span class="si">{</span><span class="n">ack</span><span class="o">.</span><span class="n">return_code</span><span class="si">}</span><span class="s2">)&quot;</span>
                                    <span class="p">),</span>
                                <span class="p">)</span>
                            
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle connection errors gracefully</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPIPE</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection lost during delete operation (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed after </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts due to connection loss&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected socket error during delete: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="n">FTPDeleteError</span><span class="p">:</span>
                <span class="k">raise</span>  <span class="c1"># propagate structured FTP errors as-is</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during delete operation (attempt </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete(&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;) failed after </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># If we reach here, the operation failed but we can retry</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying delete operation for </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s (attempt </span><span class="si">{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, DroneLeaf.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>